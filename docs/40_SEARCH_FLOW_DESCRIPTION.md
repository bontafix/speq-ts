# –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–∏—Å–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è

**–î–∞—Ç–∞:** 30.12.2025  
**–í–µ—Ä—Å–∏—è:** 1.0

## üìã –û–±–∑–æ—Ä

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ—Ü–µ—Å—Å —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ç—Ä–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤:

1. **–ê–Ω–∞–ª–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
2. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞** - –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
3. **–ó–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö** - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º

---

## üîÑ –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ (—Ç–µ–∫—Å—Ç)
    ‚Üì
[1] InteractiveQueryBuilder ‚Üí LLM
    ‚Üì
    ‚îú‚îÄ action: "ask" ‚Üí –£—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    ‚îî‚îÄ action: "final" ‚Üí SearchQuery (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å)
         ‚Üì
[2] SearchQueryValidator (–≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞)
    ‚Üì
[3] CatalogService (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞)
    ‚Üì
[4] SearchEngine.search()
    ‚îú‚îÄ QueryParameterNormalizer (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
    ‚îÇ   ‚îú‚îÄ ParameterDictionaryService (–ø–æ–∏—Å–∫ canonical –∫–ª—é—á–µ–π)
    ‚îÇ   ‚îú‚îÄ ParameterNormalizerService (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ UnitParser (–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è)
    ‚îÇ   ‚îÇ   ‚îî‚îÄ EnumMapper (–º–∞–ø–ø–∏–Ω–≥ enum –∑–Ω–∞—á–µ–Ω–∏–π)
    ‚îÇ   ‚îî‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç: normalizedQuery —Å canonical –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    ‚îÇ
    ‚îú‚îÄ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø–æ–∏—Å–∫–∞:
    ‚îÇ   ‚îú‚îÄ FTS Search (PostgreSQL tsvector)
    ‚îÇ   ‚îî‚îÄ Vector Search (pgvector + LLM embeddings)
    ‚îÇ
    ‚îî‚îÄ RRF (Reciprocal Rank Fusion) - –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
         ‚Üì
[5] EquipmentRepository
    ‚îú‚îÄ fullTextSearch() ‚Üí SQL –∑–∞–ø—Ä–æ—Å —Å normalized_parameters
    ‚îî‚îÄ vectorSearchWithEmbedding() ‚Üí SQL –∑–∞–ø—Ä–æ—Å —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
         ‚Üì
[6] PostgreSQL ‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
```

---

## 1Ô∏è‚É£ –ê–Ω–∞–ª–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: `InteractiveQueryBuilder`

**–§–∞–π–ª:** `src/llm/interactive-query.builder.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `SearchQuery` —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥ —Å LLM.

### –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã:

#### –®–∞–≥ 1.1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```typescript
// src/telegram/index.ts:232
const step = await builder.next(text);
```

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä:
- `"–ú–Ω–µ –Ω—É–∂–µ–Ω –∫—Ä–∞–Ω"`
- `"–ù—É–∂–µ–Ω —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä Caterpillar —Å –∫–æ–≤—à–æ–º –æ—Ç 1 –∫—É–±–æ–º–µ—Ç—Ä–∞"`
- `"–ü–æ–∫–∞–∂–∏ –∫—Ä–∞–Ω—ã –≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å—é –±–æ–ª–µ–µ 80 —Ç–æ–Ω–Ω –≤ –ú–æ—Å–∫–≤–µ"`

#### –®–∞–≥ 1.2: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ LLM

```74:283:src/llm/interactive-query.builder.ts
export interface InteractiveQueryBuilderOptions {

  maxTurns?: number;
  history?: ChatMessage[] | undefined;
}

export class InteractiveQueryBuilder {
  private readonly messages: ChatMessage[];
  private turns = 0;
  private readonly MAX_CONTEXT_MESSAGES = 20; // –ú–∞–∫—Å. —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ (–∫—Ä–æ–º–µ system)

  constructor(
    private readonly provider: Pick<LLMProvider, "chat">,
    private readonly options: InteractiveQueryBuilderOptions,
  ) {
    if (this.options.history && this.options.history.length > 0) {
      this.messages = [...this.options.history];
    } else {
      this.messages = [
        {
          role: "system",
          content: `
–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–æ–¥–±–æ—Ä—É –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –í –î–ò–ê–õ–û–ì–ï –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –≤ JSON-–æ–±—ä–µ–∫—Ç SearchQuery.

–¢—ã –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—à—å –°–¢–†–û–ì–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π.
–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –¢–û–õ–¨–ö–û –æ–¥–∏–Ω –∏–∑:

1) {"action":"ask","question":"..."}
   –ò—Å–ø–æ–ª—å–∑—É–π, –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –µ—Å—Ç—å –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç—å (1 –≤–æ–ø—Ä–æ—Å –∑–∞ —à–∞–≥).
   –í–ê–ñ–ù–û: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∑–≤–∞–ª —Ç–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∫—Ä–∞–Ω"), –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–ø—Ä–æ—Å–∏ –ø—Ä–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å, –±—Ä–µ–Ω–¥, —Ä–µ–≥–∏–æ–Ω).
   –ù–µ –¥–µ–ª–∞–π –ø–æ–∏—Å–∫ –ø–æ —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–æ–º—É –∑–∞–ø—Ä–æ—Å—É, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —è–≤–Ω–∞—è –ø—Ä–æ—Å—å–±–∞ "–ø–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë".
   
   –ï–°–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –°–ü–†–ê–®–ò–í–ê–ï–¢ "–ß–¢–û –¢–´ –£–ú–ï–ï–®–¨?" –ò–õ–ò "–ß–¢–û –ï–°–¢–¨ –í –ö–ê–¢–ê–õ–û–ì–ï?":
   –û—Ç–≤–µ—á–∞–π —á–µ—Ä–µ–∑ action="ask" —Å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ–º –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
   –ü—Ä–∏–º–µ—Ä: {"action":"ask","question":"–í –Ω–∞—à–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ –±–æ–ª–µ–µ 1000 –µ–¥–∏–Ω–∏—Ü —Ç–µ—Ö–Ω–∏–∫–∏: –∞–≤—Ç–æ–∫—Ä–∞–Ω—ã, —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä—ã, –±—É–ª—å–¥–æ–∑–µ—Ä—ã, –ø–æ–≥—Ä—É–∑—á–∏–∫–∏ –∏ –¥—Ä—É–≥–æ–µ. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"}

2) {"action":"final","query":{...}}
   –ò—Å–ø–æ–ª—å–∑—É–π, –∫–æ–≥–¥–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö (–µ—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ò —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä/–±—Ä–µ–Ω–¥/—Ä–µ–≥–∏–æ–Ω) –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –∏—Å–∫–∞—Ç—å "–∫–∞–∫ –µ—Å—Ç—å".
   {
     "text"?: string;           // –¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
     "category"?: string;        // –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–µ—Ö–Ω–∏–∫–∏ (—Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
     "brand"?: string;           // –ë—Ä–µ–Ω–¥/–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å (—Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
     "region"?: string;          // –†–µ–≥–∏–æ–Ω (—Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
     "parameters"?: Record<string, string | number>;  // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
     "limit"?: number;           // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)
   }

–í–ê–ñ–ù–û! –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –ø–æ–ª—è–º–∏:
- "text" ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –í–ï–ö–¢–û–†–ù–û–ì–û (—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ) –ø–æ–∏—Å–∫–∞. –°—é–¥–∞ –ø–æ–º–µ—â–∞–π –æ–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞.
  –ü—Ä–∏–º–µ—Ä: "—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä –¥–ª—è –∑–µ–º–ª—è–Ω—ã—Ö —Ä–∞–±–æ—Ç", "–≥—É—Å–µ–Ω–∏—á–Ω—ã–π –∫—Ä–∞–Ω", "–ø–æ–≥—Ä—É–∑—á–∏–∫ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—ã–π"
  
- "category", "brand", "region" ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –¢–û–ß–ù–û–ô —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ –ë–î.
  –ü–æ–º–µ—â–∞–π —Å—é–¥–∞ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ —É–∫–∞–∑–∞–ª –∫–∞—Ç–µ–≥–æ—Ä–∏—é/–±—Ä–µ–Ω–¥.
  –ü—Ä–∏–º–µ—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π: "–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä", "–ö—Ä–∞–Ω", "–ü–æ–≥—Ä—É–∑—á–∏–∫", "–ë—É–ª—å–¥–æ–∑–µ—Ä", "–°–ø–µ—Ü—Ç–µ—Ö–Ω–∏–∫–∞"
  –ü—Ä–∏–º–µ—Ä—ã –±—Ä–µ–Ω–¥–æ–≤: "Caterpillar", "Komatsu", "Hitachi", "JCB", "Volvo"
  
- –ü–æ–ª–µ "subcategory" –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ‚Äî –æ–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–æ –∏–∑ –ø–æ–∏—Å–∫–∞.
  –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç "–∫–æ–ª–µ—Å–Ω—ã–π/–≥—É—Å–µ–Ω–∏—á–Ω—ã–π/–º–∏–Ω–∏" –∏ —Ç.–ø., –≤–∫–ª—é—á–∞–π —ç—Ç–æ –≤ "text"
  –∏/–∏–ª–∏ –≤ "parameters" (–µ—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä).
  
- "parameters" ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (JSONB –ø–æ–ª–µ –≤ –ë–î).
  –ò—Å–ø–æ–ª—å–∑—É–π –†–£–°–°–ö–ò–ï –Ω–∞–∑–≤–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: "–≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å", "–º–æ—â–Ω–æ—Å—Ç—å", "–≤–µ—Å", "–æ–±—ä–µ–º_–∫–æ–≤—à–∞" –∏ —Ç.–¥.

–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è parameters:
- –î–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ "–±–æ–ª–µ–µ/–±–æ–ª—å—à–µ/–æ—Ç X" –∏—Å–ø–æ–ª—å–∑—É–π —Å—É—Ñ—Ñ–∏–∫—Å "_min": {"–≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å_min": 80}
- –î–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ "–º–µ–Ω–µ–µ/–º–µ–Ω—å—à–µ/–¥–æ X" –∏—Å–ø–æ–ª—å–∑—É–π —Å—É—Ñ—Ñ–∏–∫—Å "_max": {"—Ç–æ–Ω–Ω–∞–∂_max": 25}
- –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è: {"–º–æ—â–Ω–æ—Å—Ç—å": 150}
- –ò–∑–≤–ª–µ–∫–∞–π —Ç–æ–ª—å–∫–æ —Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ø–í–ù–û —É–∫–∞–∑–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

–°–ë–†–û–° –ö–û–ù–¢–ï–ö–°–¢–ê:
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–∑–∫–æ –º–µ–Ω—è–µ—Ç —Ç–µ–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–∫–∞–ª–∏ –∫—Ä–∞–Ω—ã, –∞ —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Å–∏—Ç "–ø–æ–∫–∞–∂–∏ –±—É–ª—å–¥–æ–∑–µ—Ä—ã"),
  –ù–ï —Ç—è–Ω–∏ —Å—Ç–∞—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (category, parameters) –≤ –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å. –ù–∞—á–Ω–∏ —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–π —Ç–µ–º—ã.
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Ç–æ—á–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∞ –µ—Å—Ç—å –ø–æ–¥–µ—à–µ–≤–ª–µ?"),
  –°–û–•–†–ê–ù–Ø–ô –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –¥–æ–±–∞–≤–ª—è–π –Ω–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è.

–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö SearchQuery:

–ó–∞–ø—Ä–æ—Å: "–ù—É–∂–µ–Ω —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä Caterpillar —Å –∫–æ–≤—à–æ–º –æ—Ç 1 –∫—É–±–æ–º–µ—Ç—Ä–∞"
–û—Ç–≤–µ—Ç: {"action":"final","query":{"text":"—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä","category":"–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä","brand":"Caterpillar","parameters":{"–æ–±—ä–µ–º_–∫–æ–≤—à–∞_min":1}}}

–ó–∞–ø—Ä–æ—Å: "–ü–æ–∫–∞–∂–∏ –∫—Ä–∞–Ω—ã –≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å—é –±–æ–ª–µ–µ 80 —Ç–æ–Ω–Ω –≤ –ú–æ—Å–∫–≤–µ"
–û—Ç–≤–µ—Ç: {"action":"final","query":{"text":"–∫—Ä–∞–Ω","category":"–ö—Ä–∞–Ω","region":"–ú–æ—Å–∫–≤–∞","parameters":{"–≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å_min":80}}}

–ó–∞–ø—Ä–æ—Å: "–ú–Ω–µ –Ω—É–∂–µ–Ω –∫—Ä–∞–Ω"
–û—Ç–≤–µ—Ç: {"action":"ask","question":"–ö–∞–∫–æ–π —Ç–∏–ø –∫—Ä–∞–Ω–∞ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? –ö–∞–∫–∞—è –Ω—É–∂–Ω–∞ –≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å –∏ –≤ –∫–∞–∫–æ–º —Ä–µ–≥–∏–æ–Ω–µ?"}

–ó–∞–ø—Ä–æ—Å: "–ò—â—É —Ç–µ—Ö–Ω–∏–∫—É –¥–ª—è —Å—Ç—Ä–æ–π–∫–∏"
–û—Ç–≤–µ—Ç: {"action":"ask","question":"–ö–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ —Ç–∏–ø —Ç–µ—Ö–Ω–∏–∫–∏ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? –ù–∞–ø—Ä–∏–º–µ—Ä: —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä, –∫—Ä–∞–Ω, –±—É–ª—å–¥–æ–∑–µ—Ä, –ø–æ–≥—Ä—É–∑—á–∏–∫?"}

–ó–∞–ø—Ä–æ—Å: "–ì—É—Å–µ–Ω–∏—á–Ω—ã–π –±—É–ª—å–¥–æ–∑–µ—Ä –≤–µ—Å–æ–º –¥–æ 20 —Ç–æ–Ω–Ω"
–û—Ç–≤–µ—Ç: {"action":"final","query":{"text":"–≥—É—Å–µ–Ω–∏—á–Ω—ã–π –±—É–ª—å–¥–æ–∑–µ—Ä","category":"–ë—É–ª—å–¥–æ–∑–µ—Ä","parameters":{"–≤–µ—Å_max":20}}}

–í–ê–ñ–ù–û:
- –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π/–±—Ä–µ–Ω–¥–æ–≤ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ —É–∫–∞–∑–∞–ª
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª "/done" –∏–ª–∏ "—Ö–≤–∞—Ç–∏—Ç" ‚Äî –≤–µ—Ä–Ω–∏ best-effort final
- –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —è–≤–Ω–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
        `.trim(),
        },
      ];
    }
  }
```

LLM –ø–æ–ª—É—á–∞–µ—Ç:
- –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
- –ò—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### –®–∞–≥ 1.3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ LLM

```208:255:src/llm/interactive-query.builder.ts
  async next(userText: string): Promise<InteractiveQueryStep> {
    const text = userText.trim();
    if (!text) {
      throw new Error("–ü—É—Å—Ç–æ–π –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
    }

    this.messages.push({ role: "user", content: text });
    this.turns += 1;

    const maxTurns = this.options.maxTurns ?? 6;
    if (this.turns > maxTurns) {
      // –ü—Ä–æ—Å–∏–º LLM –≤—ã–¥–∞—Ç—å best-effort —Ñ–∏–Ω–∞–ª, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ü–∏–∫–ª–∏–≤–∞—Ç—å—Å—è.
      this.messages.push({
        role: "user",
        content: "–õ–∏–º–∏—Ç —É—Ç–æ—á–Ω–µ–Ω–∏–π –¥–æ—Å—Ç–∏–≥–Ω—É—Ç. –°—Ñ–æ—Ä–º–∏—Ä—É–π best-effort final SearchQuery.",
      });
    }

    const chatOptions: ChatOptions = {
      model: this.options.model,
      messages: this.messages,
      temperature: 0.1,
    };

    const response = await this.provider.chat(chatOptions);
    const raw = response.message.content;

    if (process.env.DEBUG_SEARCH) {
      console.log('\n--- LLM Interaction Log ---');
      console.log('User Input:', text);
      console.log('LLM Raw Response:', raw);
      console.log('---------------------------\n');
    }

    const step = parseStepJson(raw);

    // –ß—Ç–æ–±—ã —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥ —É—á–∏—Ç—ã–≤–∞–ª –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, –¥–æ–±–∞–≤–∏–º –µ–≥–æ –≤ –∏—Å—Ç–æ—Ä–∏—é.
    if (step.action === "ask") {
      this.messages.push({ role: "assistant", content: step.question });
    } else {
      this.messages.push({ role: "assistant", content: JSON.stringify({ action: "final" }) });
    }
    
    // –û–±—Ä–µ–∑–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    this.ensureContextLimit();

    return step;
  }
```

LLM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:

**–í–∞—Ä–∏–∞–Ω—Ç A: –£—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å**
```json
{
  "action": "ask",
  "question": "–ö–∞–∫–æ–π —Ç–∏–ø –∫—Ä–∞–Ω–∞ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? –ö–∞–∫–∞—è –Ω—É–∂–Ω–∞ –≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å?"
}
```

**–í–∞—Ä–∏–∞–Ω—Ç B: –§–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å**
```json
{
  "action": "final",
  "query": {
    "text": "—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",
    "category": "–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",
    "brand": "Caterpillar",
    "parameters": {
      "–æ–±—ä–µ–º_–∫–æ–≤—à–∞_min": 1
    }
  }
}
```

### –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã:

| –í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | –û—Ç–≤–µ—Ç LLM |
|-------------------|-----------|
| `"–ú–Ω–µ –Ω—É–∂–µ–Ω –∫—Ä–∞–Ω"` | `{"action":"ask","question":"–ö–∞–∫–æ–π —Ç–∏–ø –∫—Ä–∞–Ω–∞? –ö–∞–∫–∞—è –≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å?"}` |
| `"–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä Caterpillar —Å –∫–æ–≤—à–æ–º –æ—Ç 1 –∫—É–±–∞"` | `{"action":"final","query":{"text":"—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä","category":"–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä","brand":"Caterpillar","parameters":{"–æ–±—ä–µ–º_–∫–æ–≤—à–∞_min":1}}}` |
| `"–ö—Ä–∞–Ω—ã –±–æ–ª–µ–µ 80 —Ç–æ–Ω–Ω –≤ –ú–æ—Å–∫–≤–µ"` | `{"action":"final","query":{"text":"–∫—Ä–∞–Ω","category":"–ö—Ä–∞–Ω","region":"–ú–æ—Å–∫–≤–∞","parameters":{"–≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å_min":80}}}` |

---

## 2Ô∏è‚É£ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞

### –≠—Ç–∞–ø 2.1: –í–∞–ª–∏–¥–∞—Ü–∏—è SearchQuery

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `SearchQueryValidator`

**–§–∞–π–ª:** `src/llm/search-query.validator.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏ –æ—á–∏—â–∞–µ—Ç `SearchQuery` –æ—Ç LLM, –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π.

#### –ü—Ä–æ—Ü–µ—Å—Å –≤–∞–ª–∏–¥–∞—Ü–∏–∏:

```20:177:src/llm/search-query.validator.ts
  static validate(query: any): SearchQuery {
    if (!query || typeof query !== "object") {
      throw new Error("SearchQuery –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º");
    }

    const validated: SearchQuery = {};
    const issues: string[] = [];

    // –í–∞–ª–∏–¥–∞—Ü–∏—è text
    if (query.text !== undefined) {
      if (typeof query.text === "string") {
        const trimmed = query.text.trim();
        if (trimmed.length > 0 && trimmed.length <= 500) {
          validated.text = trimmed;
        } else if (trimmed.length > 500) {
          validated.text = trimmed.substring(0, 500);
          issues.push(`text –æ–±—Ä–µ–∑–∞–Ω –¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤`);
        }
      } else {
        issues.push(`text –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π, –ø–æ–ª—É—á–µ–Ω–æ: ${typeof query.text}`);
      }
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è category
    if (query.category !== undefined) {
      if (typeof query.category === "string") {
        const trimmed = query.category.trim();
        if (trimmed.length > 0 && trimmed.length <= 100) {
          validated.category = trimmed;
        } else if (trimmed.length > 100) {
          validated.category = trimmed.substring(0, 100);
          issues.push(`category –æ–±—Ä–µ–∑–∞–Ω –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤`);
        }
      } else {
        issues.push(`category –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π, –ø–æ–ª—É—á–µ–Ω–æ: ${typeof query.category}`);
      }
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è subcategory
    if (query.subcategory !== undefined) {
      if (typeof query.subcategory === "string") {
        const trimmed = query.subcategory.trim();
        if (trimmed.length > 0 && trimmed.length <= 100) {
          validated.subcategory = trimmed;
        } else if (trimmed.length > 100) {
          validated.subcategory = trimmed.substring(0, 100);
          issues.push(`subcategory –æ–±—Ä–µ–∑–∞–Ω –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤`);
        }
      } else {
        issues.push(`subcategory –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π, –ø–æ–ª—É—á–µ–Ω–æ: ${typeof query.subcategory}`);
      }
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è brand
    if (query.brand !== undefined) {
      if (typeof query.brand === "string") {
        const trimmed = query.brand.trim();
        if (trimmed.length > 0 && trimmed.length <= 100) {
          validated.brand = trimmed;
        } else if (trimmed.length > 100) {
          validated.brand = trimmed.substring(0, 100);
          issues.push(`brand –æ–±—Ä–µ–∑–∞–Ω –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤`);
        }
      } else {
        issues.push(`brand –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π, –ø–æ–ª—É—á–µ–Ω–æ: ${typeof query.brand}`);
      }
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è region
    if (query.region !== undefined) {
      if (typeof query.region === "string") {
        const trimmed = query.region.trim();
        if (trimmed.length > 0 && trimmed.length <= 100) {
          validated.region = trimmed;
        } else if (trimmed.length > 100) {
          validated.region = trimmed.substring(0, 100);
          issues.push(`region –æ–±—Ä–µ–∑–∞–Ω –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤`);
        }
      } else {
        issues.push(`region –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π, –ø–æ–ª—É—á–µ–Ω–æ: ${typeof query.region}`);
      }
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è limit
    if (query.limit !== undefined) {
      if (typeof query.limit === "number") {
        const limitNum = Math.floor(query.limit);
        validated.limit = Math.min(Math.max(limitNum, 1), 100);
        if (limitNum !== query.limit || limitNum < 1 || limitNum > 100) {
          issues.push(`limit –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω: ${query.limit} ‚Üí ${validated.limit}`);
        }
      } else if (typeof query.limit === "string") {
        const limitNum = parseInt(query.limit, 10);
        if (!isNaN(limitNum)) {
          validated.limit = Math.min(Math.max(limitNum, 1), 100);
          issues.push(`limit –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –∏–∑ —Å—Ç—Ä–æ–∫–∏: "${query.limit}" ‚Üí ${validated.limit}`);
        } else {
          issues.push(`limit –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º: "${query.limit}" (–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω)`);
        }
      } else {
        issues.push(`limit –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º, –ø–æ–ª—É—á–µ–Ω–æ: ${typeof query.limit}`);
      }
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è parameters
    if (query.parameters !== undefined) {
      if (typeof query.parameters === "object" && !Array.isArray(query.parameters)) {
        validated.parameters = {};
        
        for (const [key, value] of Object.entries(query.parameters)) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
          if (!this.isValidParameterKey(key)) {
            issues.push(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: "${key}" (–ø—Ä–æ–ø—É—â–µ–Ω–æ)`);
            continue;
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
          if (typeof value === "number") {
            if (Number.isFinite(value)) {
              validated.parameters[key] = value;
            } else {
              issues.push(`–ü–∞—Ä–∞–º–µ—Ç—Ä "${key}" –∏–º–µ–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${value}`);
            }
          } else if (typeof value === "string") {
            const trimmed = (value as string).trim();
            if (trimmed.length > 0 && trimmed.length <= 200) {
              validated.parameters[key] = trimmed;
            } else if (trimmed.length > 200) {
              validated.parameters[key] = trimmed.substring(0, 200);
              issues.push(`–ó–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ "${key}" –æ–±—Ä–µ–∑–∞–Ω–æ –¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤`);
            }
          } else {
            issues.push(`–ü–∞—Ä–∞–º–µ—Ç—Ä "${key}" –∏–º–µ–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø: ${typeof value} (–ø—Ä–æ–ø—É—â–µ–Ω–æ)`);
          }
        }

        // –ï—Å–ª–∏ –Ω–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, —É–¥–∞–ª—è–µ–º –ø–æ–ª–µ
        if (Object.keys(validated.parameters).length === 0) {
          delete validated.parameters;
        }
      } else {
        issues.push(`parameters –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º, –ø–æ–ª—É—á–µ–Ω–æ: ${typeof query.parameters}`);
      }
    }

    // –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–±–ª–µ–º—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (issues.length > 0) {
      console.warn(`[SearchQueryValidator] –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:`);
      issues.forEach(issue => console.warn(`  - ${issue}`));
    }

    // –ï—Å–ª–∏ –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—è, —ç—Ç–æ –æ—à–∏–±–∫–∞
    if (Object.keys(validated).length === 0) {
      throw new Error("SearchQuery –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –ø–æ–ª–µ–π –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏");
    }

    return validated;
  }
```

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö (text, category, brand, region, limit, parameters)
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Å—Ç—Ä–æ–∫ (text ‚â§ 500, category/brand/region ‚â§ 100)
- ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è limit (1-100, –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏)
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è)
- ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ SQL –∏–Ω—ä–µ–∫—Ü–∏–π –≤ –∫–ª—é—á–∞—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

**–ü—Ä–∏–º–µ—Ä –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
```typescript
// –í—Ö–æ–¥–Ω–æ–π –∑–∞–ø—Ä–æ—Å –æ—Ç LLM:
{
  limit: "–º–Ω–æ–≥–æ",
  parameters: { "'; DROP TABLE --": 123 }
}

// –ü–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:
{
  limit: 10,  // –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ
  parameters: {}  // –æ–ø–∞—Å–Ω—ã–π –∫–ª—é—á —É–¥–∞–ª–µ–Ω
}
```

### –≠—Ç–∞–ø 2.2: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `QueryParameterNormalizer`

**–§–∞–π–ª:** `src/normalization/query-parameter-normalizer.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (—Ä—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è) –≤ canonical —Ñ–æ—Ä–º–∞—Ç (snake_case –∫–ª—é—á–∏).

#### –ü—Ä–æ—Ü–µ—Å—Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:

```64:154:src/normalization/query-parameter-normalizer.ts
  normalizeQuery(query: SearchQuery): QueryNormalizationResult {
    const normalizedQuery: SearchQuery = {
      ...query,
    };

    // –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
    if (!query.parameters || Object.keys(query.parameters).length === 0) {
      return {
        normalizedQuery,
        stats: {
          total: 0,
          normalized: 0,
          unresolved: 0,
          confidence: 1.0,
        },
      };
    }

    // –†–∞–∑–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞ –æ–±—ã—á–Ω—ã–µ –∏ —Å —Å—É—Ñ—Ñ–∏–∫—Å–∞–º–∏ _min/_max
    const regularParams: Record<string, any> = {};
    const minParams: Record<string, any> = {};
    const maxParams: Record<string, any> = {};

    for (const [key, value] of Object.entries(query.parameters)) {
      if (key.endsWith("_min")) {
        const baseKey = key.replace("_min", "");
        minParams[baseKey] = value;
      } else if (key.endsWith("_max")) {
        const baseKey = key.replace("_max", "");
        maxParams[baseKey] = value;
      } else {
        regularParams[key] = value;
      }
    }

    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ–±—ã—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    const regularResult = this.normalizer.normalize(regularParams);

    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å _min
    const minResult = this.normalizer.normalize(minParams);

    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å _max
    const maxResult = this.normalizer.normalize(maxParams);

    // –°–æ–±–∏—Ä–∞–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    const normalizedParameters: Record<string, string | number> = {};

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    for (const [key, value] of Object.entries(regularResult.normalized)) {
      normalizedParameters[key] = value;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å _min
    for (const [key, value] of Object.entries(minResult.normalized)) {
      normalizedParameters[`${key}_min`] = value;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å _max
    for (const [key, value] of Object.entries(maxResult.normalized)) {
      normalizedParameters[`${key}_max`] = value;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    normalizedQuery.parameters = normalizedParameters;

    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const total =
      Object.keys(regularParams).length +
      Object.keys(minParams).length +
      Object.keys(maxParams).length;

    const normalized =
      Object.keys(regularResult.normalized).length +
      Object.keys(minResult.normalized).length +
      Object.keys(maxResult.normalized).length;

    const unresolved =
      Object.keys(regularResult.unresolved).length +
      Object.keys(minResult.unresolved).length +
      Object.keys(maxResult.unresolved).length;

    return {
      normalizedQuery,
      stats: {
        total,
        normalized,
        unresolved,
        confidence: total > 0 ? normalized / total : 1.0,
      },
    };
  }
```

#### –î–µ—Ç–∞–ª—å–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π:

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `ParameterNormalizerService`

**–§–∞–π–ª:** `src/normalization/parameter-normalizer.service.ts`

```26:100:src/normalization/parameter-normalizer.service.ts
  normalize(rawParams: Record<string, any>): NormalizationResult {
    const normalized: Record<string, any> = {};
    const unresolved: Record<string, any> = {};

    for (const [rawKey, rawValue] of Object.entries(rawParams)) {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º null/undefined
      if (rawValue == null) continue;

      // –ù–∞—Ö–æ–¥–∏–º canonical key
      const paramDef = this.dictionaryService.findCanonicalKey(rawKey);
      if (!paramDef) {
        unresolved[rawKey] = rawValue;
        continue;
      }

      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
      let normalizedValue: any = null;

      if (paramDef.param_type === "number") {
        normalizedValue = this.unitParser.parseValue(rawValue, paramDef.unit || "");

        // –ú—è–≥–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (—Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–µ –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ)
        if (normalizedValue != null && process.env.DEBUG) {
          if (paramDef.min_value != null && normalizedValue < paramDef.min_value) {
            console.warn(
              `[Normalization] –ó–Ω–∞—á–µ–Ω–∏–µ ${normalizedValue} –Ω–∏–∂–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–≥–æ –º–∏–Ω–∏–º—É–º–∞ ${paramDef.min_value} –¥–ª—è ${paramDef.key} (–µ–¥–∏–Ω–∏—Ü–∞: ${paramDef.unit})`
            );
          }
          if (paramDef.max_value != null && normalizedValue > paramDef.max_value) {
            console.warn(
              `[Normalization] –ó–Ω–∞—á–µ–Ω–∏–µ ${normalizedValue} –≤—ã—à–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–≥–æ –º–∞–∫—Å–∏–º—É–º–∞ ${paramDef.max_value} –¥–ª—è ${paramDef.key} (–µ–¥–∏–Ω–∏—Ü–∞: ${paramDef.unit})`
            );
          }
        }
      } else if (paramDef.param_type === "enum") {
        normalizedValue = this.enumMapper.mapEnumValue(String(rawValue), paramDef);
      } else if (paramDef.param_type === "boolean") {
        const str = String(rawValue).toLowerCase();
        if (str === "true" || str === "1" || str === "–¥–∞" || str === "yes") {
          normalizedValue = true;
        } else if (str === "false" || str === "0" || str === "–Ω–µ—Ç" || str === "no") {
          normalizedValue = false;
        }
      } else if (paramDef.param_type === "string") {
        // –î–ª—è —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –ø–æ–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–®–∏–Ω—ã", "–ö–∞–±–∏–Ω–∞") —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å.
        // –í–∞–∂–Ω–æ: –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å—á–∏—Ç–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏.
        if (typeof rawValue === "string") {
          const s = rawValue.trim();
          normalizedValue = s.length > 0 ? s : null;
        } else if (typeof rawValue === "number" || typeof rawValue === "boolean") {
          normalizedValue = String(rawValue);
        } else {
          // –æ–±—ä–µ–∫—Ç—ã/–º–∞—Å—Å–∏–≤—ã
          const s = JSON.stringify(rawValue);
          normalizedValue = s && s !== "{}" && s !== "[]" ? s : null;
        }
      }

      if (normalizedValue != null) {
        normalized[paramDef.key] = normalizedValue;
      } else {
        unresolved[rawKey] = rawValue;
      }
    }

    const total = Object.keys(rawParams).length;
    const normalizedCount = Object.keys(normalized).length;
    const confidence = total > 0 ? normalizedCount / total : 0;

    return {
      normalized,
      unresolved,
      confidence,
    };
  }
```

**–ü—Ä–æ—Ü–µ—Å—Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **–ü–æ–∏—Å–∫ canonical –∫–ª—é—á–∞** —á–µ—Ä–µ–∑ `ParameterDictionaryService`:
   - –ò—â–µ—Ç –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ `parameter_dictionary` –ø–æ –∞–ª–∏–∞—Å–∞–º
   - –ü—Ä–∏–º–µ—Ä: `"–ú–æ—â–Ω–æ—Å—Ç—å"` ‚Üí `"power_hp"` –∏–ª–∏ `"power_kw"`

2. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏—è** –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞:
   - **number**: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è —á–µ—Ä–µ–∑ `UnitParser`
     - `"132 –ª.—Å."` ‚Üí `132` (–µ—Å–ª–∏ –µ–¥–∏–Ω–∏—Ü–∞ `hp`)
     - `"25 —Ç–æ–Ω–Ω"` ‚Üí `25000` (–µ—Å–ª–∏ –µ–¥–∏–Ω–∏—Ü–∞ `kg`)
   - **enum**: –ú–∞–ø–ø–∏–Ω–≥ —á–µ—Ä–µ–∑ `EnumMapper`
     - `"–î–∏–∑–µ–ª—å–Ω—ã–π"` ‚Üí `"diesel"`
     - `"–ì—É—Å–µ–Ω–∏—á–Ω—ã–π"` ‚Üí `"crawler"`
   - **boolean**: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ –≤ boolean
     - `"–¥–∞"` ‚Üí `true`
     - `"–Ω–µ—Ç"` ‚Üí `false`

#### –ü—Ä–∏–º–µ—Ä –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:

**–í—Ö–æ–¥–Ω–æ–π –∑–∞–ø—Ä–æ—Å –æ—Ç LLM:**
```json
{
  "text": "—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",
  "category": "–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",
  "brand": "Caterpillar",
  "parameters": {
    "–ú–æ—â–Ω–æ—Å—Ç—å": "132 –ª.—Å.",
    "–†–∞–±–æ—á–∏–π –≤–µ—Å_max": "25000 –∫–≥",
    "–¢–∏–ø –ø–∏—Ç–∞–Ω–∏—è": "–î–∏–∑–µ–ª—å–Ω—ã–π"
  }
}
```

**–ü–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:**
```json
{
  "text": "—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",
  "category": "–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",
  "brand": "Caterpillar",
  "parameters": {
    "power_hp": 132,
    "weight_kg_max": 25000,
    "fuel_type": "diesel"
  }
}
```

---

## 3Ô∏è‚É£ –ó–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –≠—Ç–∞–ø 3.1: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ SQL —É—Å–ª–æ–≤–∏–π

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `QueryParameterNormalizer.buildSQLConditions()`

**–§–∞–π–ª:** `src/normalization/query-parameter-normalizer.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ SQL —É—Å–ª–æ–≤–∏—è –¥–ª—è WHERE.

```176:226:src/normalization/query-parameter-normalizer.ts
  buildSQLConditions(
    normalizedParameters: Record<string, string | number>,
    values: any[]
  ): string[] {
    const conditions: string[] = [];

    for (const [key, value] of Object.entries(normalizedParameters)) {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É—Ñ—Ñ–∏–∫—Å–æ–≤ _min –∏ _max
      if (key.endsWith("_min")) {
        const paramKey = key.replace("_min", "");
        const numValue = typeof value === "string" ? parseFloat(value) : Number(value);
        if (!Number.isNaN(numValue)) {
          values.push(paramKey, numValue);
          const keyIndex = values.length - 1;
          const valueIndex = values.length;
          conditions.push(
            `(normalized_parameters->>$${keyIndex})::numeric >= $${valueIndex}`
          );
        }
      } else if (key.endsWith("_max")) {
        const paramKey = key.replace("_max", "");
        const numValue = typeof value === "string" ? parseFloat(value) : Number(value);
        if (!Number.isNaN(numValue)) {
          values.push(paramKey, numValue);
          const keyIndex = values.length - 1;
          const valueIndex = values.length;
          conditions.push(
            `(normalized_parameters->>$${keyIndex})::numeric <= $${valueIndex}`
          );
        }
      } else {
        // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        values.push(key, value);
        const keyIndex = values.length - 1;
        const valueIndex = values.length;

        // –î–ª—è —á–∏—Å–µ–ª –∏—Å–ø–æ–ª—å–∑—É–µ–º numeric —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ, –¥–ª—è —Å—Ç—Ä–æ–∫ - text
        if (typeof value === "number") {
          conditions.push(
            `(normalized_parameters->>$${keyIndex})::numeric = $${valueIndex}`
          );
        } else {
          conditions.push(
            `normalized_parameters->>$${keyIndex} = $${valueIndex}::text`
          );
        }
      }
    }

    return conditions;
  }
```

**–ü—Ä–∏–º–µ—Ä—ã SQL —É—Å–ª–æ–≤–∏–π:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | SQL —É—Å–ª–æ–≤–∏–µ |
|----------|-------------|
| `power_hp: 132` | `(normalized_parameters->>$1)::numeric = $2` |
| `weight_kg_min: 20000` | `(normalized_parameters->>$1)::numeric >= $2` |
| `weight_kg_max: 25000` | `(normalized_parameters->>$1)::numeric <= $2` |
| `fuel_type: "diesel"` | `normalized_parameters->>$1 = $2::text` |

### –≠—Ç–∞–ø 3.2: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ FTS –ø–æ–∏—Å–∫–∞

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `EquipmentRepository.fullTextSearch()`

**–§–∞–π–ª:** `src/repository/equipment.repository.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

```165:244:src/repository/equipment.repository.ts
  async fullTextSearch(query: SearchQuery, limit: number): Promise<EquipmentSummary[]> {
    const values: any[] = [];
    const whereParts: string[] = ["is_active = true"];
    let rankExpression = "0::float4";

    // –¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ tsvector-–∫–æ–ª–æ–Ω–∫—É search_vector
    if (query.text && query.text.trim()) {
      values.push(query.text.trim());
      const placeholder = `$${values.length}`;
      whereParts.push(`search_vector @@ plainto_tsquery('russian', ${placeholder})`);
      rankExpression = `ts_rank(search_vector, plainto_tsquery('russian', ${placeholder}))`;
    }

    if (query.category && query.category.trim()) {
      // –†–∞–Ω—å—à–µ –±—ã–ª–æ —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ, –Ω–æ LLM —á–∞—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "–ö—Ä–∞–Ω",
      // —Ç–æ–≥–¥–∞ –∫–∞–∫ –≤ –ë–î –∫–∞—Ç–µ–≥–æ—Ä–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å "–ö—Ä–∞–Ω—ã"/"–ê–≤—Ç–æ–∫—Ä–∞–Ω—ã"/"–ì—É—Å–µ–Ω–∏—á–Ω—ã–µ –∫—Ä–∞–Ω—ã".
      // –î–µ–ª–∞–µ–º –º—è–≥–∫–∏–π –º–∞—Ç—á –ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ (case-insensitive).
      values.push(`%${query.category.trim()}%`);
      whereParts.push(`category ILIKE $${values.length}`);
    }
    if (query.brand && query.brand.trim()) {
      values.push(query.brand.trim());
      whereParts.push(`brand = $${values.length}`);
    }
    if (query.region && query.region.trim()) {
      values.push(query.region.trim());
      whereParts.push(`region = $${values.length}`);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ main_parameters (JSONB)
    if (query.parameters && Object.keys(query.parameters).length > 0) {
      for (const [key, value] of Object.entries(query.parameters)) {
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –£–ñ–ï –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ SearchEngine
        // –ü—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∏–º SQL —É—Å–ª–æ–≤–∏–µ
        const condition = this.buildParameterCondition(key, value);
        if (!condition) continue;
        
        const { paramKey, value: conditionValue, operator, sqlCast } = condition;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª–æ–≤–∏–µ –≤ WHERE —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–µ–π
      values.push(paramKey, conditionValue);
        const keyIndex = values.length - 1;
        const valueIndex = values.length;
        
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º normalized_parameters –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ canonical –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
        whereParts.push(
        `(normalized_parameters->>$${keyIndex})${sqlCast} ${operator} $${valueIndex}`
        );
      }
    }

    const whereClause = whereParts.length > 0 ? `WHERE ${whereParts.join(" AND ")}` : "";

    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ limit —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä
    const safeLimit = Number.isInteger(limit) && limit > 0 ? limit : 10;

    const sql = `
      SELECT
        id::text AS id,
        name,
        category,
        brand,
        price,
        main_parameters AS "mainParameters"
      FROM equipment
      ${whereClause}
      ORDER BY ${rankExpression} DESC, name ASC
      LIMIT $${values.length + 1}
    `;

    if (process.env.DEBUG_SEARCH) {
      console.log('\n--- FTS SQL Log ---');
      console.log('Query:', sql.replace(/\s+/g, ' ').trim());
      console.log('Params:', values);
      console.log('-------------------\n');
    }

    const result = await pgPool.query(sql, [...values, safeLimit]);
    return result.rows;
  }
```

**–ü—Ä–∏–º–µ—Ä SQL –∑–∞–ø—Ä–æ—Å–∞:**

–î–ª—è –∑–∞–ø—Ä–æ—Å–∞:
```json
{
  "text": "—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",
  "category": "–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",
  "brand": "Caterpillar",
  "parameters": {
    "power_hp": 132,
    "weight_kg_max": 25000
  }
}
```

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è SQL:
```sql
SELECT
  id::text AS id,
  name,
  category,
  brand,
  price,
  main_parameters AS "mainParameters"
FROM equipment
WHERE is_active = true
  AND search_vector @@ plainto_tsquery('russian', $1)
  AND category ILIKE $2
  AND brand = $3
  AND (normalized_parameters->>$4)::numeric = $5
  AND (normalized_parameters->>$6)::numeric <= $7
ORDER BY ts_rank(search_vector, plainto_tsquery('russian', $1)) DESC, name ASC
LIMIT $8
```

–° –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
```javascript
[
  "—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",      // $1 - text
  "%–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä%",    // $2 - category
  "Caterpillar",     // $3 - brand
  "power_hp",        // $4 - param key
  132,               // $5 - param value
  "weight_kg",       // $6 - param key
  25000,             // $7 - param value
  10                 // $8 - limit
]
```

### –≠—Ç–∞–ø 3.3: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ (FTS + Vector)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `SearchEngine.search()`

**–§–∞–π–ª:** `src/search/search.engine.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ FTS –∏ Vector –ø–æ–∏—Å–∫–∞, –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ RRF.

```64:193:src/search/search.engine.ts
  async search(query: SearchQuery): Promise<CatalogSearchResult> {
    const limit = query.limit ?? 10;

    // 1. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    let normalizedQuery = query;
    if (this.queryNormalizer && query.parameters) {
      try {
        // –°–ª–æ–≤–∞—Ä—å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ —á–µ—Ä–µ–∑ initializeDictionary()
        // –ï—Å–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –∂–¥–µ–º (—ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö)
        if (!this.dictionaryInitialized && this.dictionaryService) {
          await this.dictionaryService.loadDictionary();
          this.dictionaryInitialized = true;
        }
        
        const result = this.queryNormalizer.normalizeQuery(query);
        normalizedQuery = result.normalizedQuery;
        
        if (process.env.DEBUG || process.env.DEBUG_SEARCH) {
          console.log('[SearchEngine] Normalized query params:', JSON.stringify(normalizedQuery, null, 2));
        }

        // –õ–æ–≥–∏—Ä—É–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, –Ω–æ –Ω–µ –º–µ—à–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        if (result.stats.unresolved > 0 && process.env.DEBUG) {
          console.warn(`[Search] Unresolved params: ${result.stats.unresolved}`);
        }
      } catch (error) {
        console.warn(`[Search] Normalization error: ${error}`);
      }
    }

    // 2. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
    
    // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: FTS (–¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–ª–æ–≤ + –§–∏–ª—å—Ç—Ä—ã)
    const ftsPromise = this.equipmentRepository.fullTextSearch(normalizedQuery, limit);

    // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: Vector (–°–º—ã—Å–ª–æ–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
    let vectorPromise: Promise<EquipmentSummary[]> = Promise.resolve([]);
    let embeddingPromise: Promise<number[] | null> = Promise.resolve(null);
    
    // –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –≤–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏ –¥–æ—Å—Ç—É–ø–µ–Ω LLM –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–∞
    const vectorEnabled = process.env.ENABLE_VECTOR_SEARCH !== "false"; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ

    if (vectorEnabled && normalizedQuery.text && normalizedQuery.text.trim().length > 0 && this.llmFactory) {
      // 2.1 –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥ –æ–¥–∏–Ω —Ä–∞–∑
      embeddingPromise = this.getEmbedding(normalizedQuery.text);
      
      // 2.2 –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–≥–∏–π –ø–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
      vectorPromise = embeddingPromise.then(vector => {
        if (!vector) return [];
        
        // –ü–µ—Ä–µ–¥–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –≤ vector search (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–¥–∞–Ω—ã)
        const filters: any = {};
        if (normalizedQuery.category) filters.category = normalizedQuery.category;
        if (normalizedQuery.brand) filters.brand = normalizedQuery.brand;
        if (normalizedQuery.region) filters.region = normalizedQuery.region;
        if (normalizedQuery.parameters) filters.parameters = normalizedQuery.parameters;
        
        return this.equipmentRepository.vectorSearchWithEmbedding(normalizedQuery.text!, vector, limit, filters);
      });
    }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Promise.all –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (FTS –∏ Vector –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
    const [ftsResult, vectorResult, embeddingResult] = await Promise.allSettled([
      ftsPromise, 
      vectorPromise,
      embeddingPromise
    ]);
    
    let ftsResults = ftsResult.status === 'fulfilled' ? ftsResult.value : [];
    let vectorResults = vectorResult.status === 'fulfilled' ? vectorResult.value : [];
    const queryEmbedding = embeddingResult.status === 'fulfilled' ? embeddingResult.value : null;

    // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
    if (ftsResult.status === 'rejected') console.error('[Search] FTS search failed:', ftsResult.reason);
    if (vectorResult.status === 'rejected') console.warn('[Search] Vector search failed:', vectorResult.reason);

    // 2.3 RELAXED VECTOR SEARCH (FALLBACK)
    // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–∞–ª–æ (< 3), –∏ –µ—Å—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —á—Ç–æ-—Ç–æ "–ø–æ–º—è–≥—á–µ".
    //
    // –í–ê–ñ–ù–û: "relaxed" –¥–æ–ª–∂–µ–Ω –æ—Å–ª–∞–±–ª—è—Ç—å —Ç–æ–ª—å–∫–æ "–º—è–≥–∫–∏–µ" —Ñ–∏–ª—å—Ç—Ä—ã (–∫–∞—Ç–µ–≥–æ—Ä–∏—è/–±—Ä–µ–Ω–¥),
    // –Ω–æ –ù–ï –¥–æ–ª–∂–µ–Ω –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (parameters) –∏/–∏–ª–∏ —Ä–µ–≥–∏–æ–Ω,
    // –∏–Ω–∞—á–µ –≤ –≤—ã–¥–∞—á—É –ø–æ–ø–∞–¥—É—Ç –ø–æ–∑–∏—Ü–∏–∏, –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª–æ–≤–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    const hasFilters =
      normalizedQuery.category ||
      normalizedQuery.brand ||
      normalizedQuery.region ||
      normalizedQuery.parameters;
    let relaxedResults: EquipmentSummary[] = [];

    if (queryEmbedding && (ftsResults.length + vectorResults.length) < 3 && hasFilters) {
      if (process.env.DEBUG_SEARCH) {
        console.log('[Search] Low results with filters. Attempting relaxed vector search...');
      }
      try {
        // –ò—â–µ–º –ø–æ —Å–º—ã—Å–ª—É, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º "–∂–µ—Å—Ç–∫–∏–µ" –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (parameters/region),
        // –æ—Å–ª–∞–±–ª—è—è —Ç–æ–ª—å–∫–æ category/brand.
        const relaxedFilters: any = {};
        if (normalizedQuery.region) relaxedFilters.region = normalizedQuery.region;
        if (normalizedQuery.parameters) relaxedFilters.parameters = normalizedQuery.parameters;

        relaxedResults = await this.equipmentRepository.vectorSearchWithEmbedding(
            normalizedQuery.text!, 
            queryEmbedding, 
            limit,
            Object.keys(relaxedFilters).length > 0 ? relaxedFilters : undefined
        );
      } catch (e) {
        console.warn('[Search] Relaxed vector search failed:', e);
      }
    }

    // 3. –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤–æ–æ–±—â–µ - –ø—Ä–æ–±—É–µ–º fallback (FTS –±–µ–∑ category)
    if (ftsResults.length === 0 && vectorResults.length === 0 && relaxedResults.length === 0) {
      return await this.handleNoResults(normalizedQuery, limit);
    }

    // 4. –ì–∏–±—Ä–∏–¥–Ω–æ–µ —Å–ª–∏—è–Ω–∏–µ (RRF)
    const merged = this.hybridFusion(ftsResults, vectorResults, relaxedResults, limit);
    
    const strategies: string[] = [];
    if (ftsResults.length > 0) strategies.push("fts");
    if (vectorResults.length > 0) strategies.push("vector_strict");
    if (relaxedResults.length > 0) strategies.push("vector_relaxed");

    return {
      items: merged,
      total: merged.length,
      usedStrategy: strategies.length > 1 ? "mixed" : (strategies[0] as any || "fts"),
    };
  }
```

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤** (–µ—Å–ª–∏ –µ—Å—Ç—å)
2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫:**
   - FTS –ø–æ–∏—Å–∫ (PostgreSQL tsvector)
   - Vector –ø–æ–∏—Å–∫ (pgvector + embeddings)
3. **–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** —á–µ—Ä–µ–∑ RRF (Reciprocal Rank Fusion)
4. **Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏** –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–∞–ª–æ

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö

### –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
```
"–ù—É–∂–µ–Ω —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä Caterpillar —Å –∫–æ–≤—à–æ–º –æ—Ç 1 –∫—É–±–æ–º–µ—Ç—Ä–∞"
```

### –ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ LLM:
```json
{
  "action": "final",
  "query": {
    "text": "—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",
    "category": "–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",
    "brand": "Caterpillar",
    "parameters": {
      "–æ–±—ä–µ–º_–∫–æ–≤—à–∞_min": 1
    }
  }
}
```

### –ü–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:
```json
{
  "text": "—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",
  "category": "–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",
  "brand": "Caterpillar",
  "parameters": {
    "bucket_volume_m3_min": 1
  }
}
```

### SQL –∑–∞–ø—Ä–æ—Å –∫ –ë–î:
```sql
SELECT id, name, category, brand, price, main_parameters
FROM equipment
WHERE is_active = true
  AND search_vector @@ plainto_tsquery('russian', '—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä')
  AND category ILIKE '%–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä%'
  AND brand = 'Caterpillar'
  AND (normalized_parameters->>'bucket_volume_m3')::numeric >= 1
ORDER BY ts_rank(...) DESC, name ASC
LIMIT 10
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π:

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:**
   ```typescript
   // –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ: –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
   /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_]+$/
   ```

2. **–ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:**
   - –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã PostgreSQL
   - –ò–º–µ–Ω–∞ –∫–ª—é—á–µ–π –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

3. **–ü—Ä–∏–º–µ—Ä—ã –±–ª–æ–∫–∏—Ä—É–µ–º—ã—Ö –∞—Ç–∞–∫:**
   ```typescript
   // SQL –∏–Ω—ä–µ–∫—Ü–∏—è
   { "'; DROP TABLE --": 123 } ‚Üí —É–¥–∞–ª–µ–Ω–æ
   
   // Path traversal
   { "../../../etc/passwd": "value" } ‚Üí —É–¥–∞–ª–µ–Ω–æ
   ```

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- **–¢–µ—Å—Ç –∞–ª–≥–æ—Ä–∏—Ç–º–∞:** `docs/35_MESSAGE_ANALYSIS_ALGORITHM_TEST.md`
- **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:** `docs/39_NORMALIZATION_QUICK_START.md`
- **–°–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:** `docs/36_PARAMETER_COLLECTION_AND_ANALYSIS.md`
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–∏—Å–∫–∞:** `docs/19_DIALOG_AND_SEARCH_ANALYSIS.md`
