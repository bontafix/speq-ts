# Тест алгоритма анализа сообщений пользователя

**Дата:** 30.12.2025  
**Статус:** ✅ Все тесты пройдены (14/14)

## Обзор

Алгоритм анализа сообщений пользователя преобразует естественный язык в структурированный поисковый запрос к базе данных. Этот документ описывает проверку работы алгоритма.

## Архитектура алгоритма

```
Пользовательский ввод (текст)
    ↓
InteractiveQueryBuilder → LLM
    ↓
    ├─ action: "ask" → уточняющий вопрос
    └─ action: "final" → SearchQuery
         ↓
SearchQueryValidator (валидация и нормализация)
    ↓
QueryParameterNormalizer (нормализация параметров)
    ↓
Построение SQL условий
    ↓
Выполнение запроса к БД
```

## Компоненты алгоритма

### 1. InteractiveQueryBuilder

**Файл:** `src/llm/interactive-query.builder.ts`

**Назначение:** Преобразует текст пользователя в структурированный `SearchQuery` через диалог с LLM.

**Функционал:**
- Анализирует запрос пользователя через LLM
- Может задавать уточняющие вопросы (`action: "ask"`)
- Формирует финальный запрос (`action: "final"`)
- Управляет историей диалога (ограничение до 20 сообщений)
- Валидирует ответы LLM через `SearchQueryValidator`

**Примеры работы:**
- `"Мне нужен кран"` → `{"action":"ask","question":"Какой тип крана вас интересует?"}`
- `"Нужен экскаватор Caterpillar с ковшом от 1 кубометра"` → `{"action":"final","query":{...}}`

### 2. SearchQueryValidator

**Файл:** `src/llm/search-query.validator.ts`

**Назначение:** Валидирует и нормализует `SearchQuery` от LLM.

**Проверки:**
- ✅ Валидация типов данных (text, category, brand, region, limit, parameters)
- ✅ Ограничение длины строк (text ≤ 500, category/brand/region ≤ 100)
- ✅ Нормализация limit (1-100, преобразование из строки)
- ✅ **Безопасность:** Валидация имен параметров (только буквы, цифры, подчеркивания)
- ✅ Блокировка SQL инъекций в ключах параметров

**Примеры:**
```typescript
// Некорректный limit нормализуется
{ limit: "много" } → { limit: 10 } (по умолчанию)

// SQL инъекция блокируется
{ parameters: { "'; DROP TABLE --": 123 } } → { parameters: {} } (удалено)
```

### 3. QueryParameterNormalizer

**Файл:** `src/normalization/query-parameter-normalizer.ts`

**Назначение:** Нормализует параметры из произвольного формата в canonical формат.

**Функционал:**
- Преобразует русские названия параметров в canonical ключи
- Обрабатывает диапазоны (`_min`, `_max`)
- Преобразует единицы измерения
- Маппит enum значения

**Пример:**
```typescript
// Входной запрос от LLM:
{
  parameters: {
    "грузоподъемность_min": 80,
    "вес_max": 20000
  }
}

// Нормализованный запрос:
{
  parameters: {
    "lifting_capacity_kg_min": 80,
    "weight_kg_max": 20000
  }
}
```

### 4. Построение SQL условий

**Файл:** `src/normalization/query-parameter-normalizer.ts` (метод `buildSQLConditions`)

**Назначение:** Создает параметризованные SQL условия для WHERE.

**Примеры SQL:**
```sql
-- Для _min параметра
(normalized_parameters->>$1)::numeric >= $2

-- Для _max параметра
(normalized_parameters->>$1)::numeric <= $2

-- Для точного значения
(normalized_parameters->>$1)::numeric = $2
```

## Результаты тестирования

### Тест 1: InteractiveQueryBuilder ✅ (5/5)

| Тест | Статус |
|------|--------|
| Запрос только категории → уточнение | ✅ |
| Полный запрос с параметрами | ✅ |
| Запрос с диапазонами (min/max) | ✅ |
| Запрос с несколькими параметрами | ✅ |
| Некорректные данные → валидация | ✅ |

### Тест 2: SearchQueryValidator ✅ (4/4)

| Тест | Статус |
|------|--------|
| Валидный запрос проходит проверку | ✅ |
| Некорректный limit нормализуется | ✅ |
| SQL инъекция в ключе блокируется | ✅ |
| Пустой запрос отклоняется | ✅ |

### Тест 3: QueryParameterNormalizer ✅ (2/2)

| Тест | Статус |
|------|--------|
| Нормализация параметров с _min/_max | ✅ |
| Запрос без параметров | ✅ |

### Тест 4: Построение SQL условий ✅ (3/3)

| Тест | Статус |
|------|--------|
| SQL условие для _min параметра | ✅ |
| SQL условие для _max параметра | ✅ |
| SQL условие для точного значения | ✅ |

## Безопасность

### Защита от SQL инъекций

1. **Валидация имен параметров:**
   - Разрешены только: буквы (латиница + кириллица), цифры, подчеркивания
   - Максимальная длина: 100 символов
   - Некорректные ключи удаляются

2. **Параметризованные запросы:**
   - Все значения передаются через параметры PostgreSQL
   - Имена ключей валидируются перед использованием

3. **Примеры блокируемых атак:**
   ```typescript
   // SQL инъекция
   { "'; DROP TABLE --": 123 } → удалено
   
   // Path traversal
   { "../../../etc/passwd": "value" } → удалено
   
   // XSS
   { "<script>alert(1)</script>": "value" } → удалено
   ```

## Запуск тестов

```bash
npx tsx src/scripts/test-message-analysis-algorithm.ts
```

## Выводы

✅ **Алгоритм работает корректно:**
- Правильно преобразует текст в структурированный запрос
- Валидирует и нормализует данные
- Защищает от SQL инъекций
- Обрабатывает различные форматы запросов

✅ **Все компоненты протестированы:**
- InteractiveQueryBuilder
- SearchQueryValidator
- QueryParameterNormalizer
- Построение SQL условий

✅ **Безопасность обеспечена:**
- Валидация входных данных
- Параметризованные SQL запросы
- Блокировка опасных паттернов

## Рекомендации

1. **Мониторинг:** Добавить логирование всех преобразований для анализа качества работы LLM
2. **Метрики:** Отслеживать процент успешных преобразований и частоту уточняющих вопросов
3. **A/B тестирование:** Сравнить качество поиска с разными промптами для LLM
