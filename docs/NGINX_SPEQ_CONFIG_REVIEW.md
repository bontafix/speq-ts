# –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx –¥–ª—è SPEQ

## ‚úÖ –ß—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ

### 1. SPEQ BOT (PROD) - `/speq-bot`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: `proxy_pass http://127.0.0.1:7504/;` (—Å –∑–∞–≤–µ—Ä—à–∞—é—â–∏–º —Å–ª–µ—à–µ–º)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –æ—Ç–∫–ª—é—á–µ–Ω–∞ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: —É–≤–µ–ª–∏—á–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –¥–æ 90s –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ LLM
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏

### 2. SPEQ DEV - `/speq-dev/`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –∑–∞–≤–µ—Ä—à–∞—é—â–∏–π —Å–ª–µ—à –≤ location –∏ proxy_pass
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Forwarded-Prefix` –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç

### 3. SPEQ STAGE - `/speq-stage/`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –∑–∞–≤–µ—Ä—à–∞—é—â–∏–π —Å–ª–µ—à –≤ location –∏ proxy_pass
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Forwarded-Prefix`

### 4. SPEQ IMAGES - `/speq-images/`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 30 –¥–Ω–µ–π
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

## üîß –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ/—É–ª—É—á—à–µ–Ω–æ

### 1. –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π location –¥–ª—è webhook Telegram

–î–æ–±–∞–≤–ª–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π `location /speq-bot/telegram/webhook` —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:

```nginx
location /speq-bot/telegram/webhook {
    proxy_pass http://127.0.0.1:7504/telegram/webhook;
    # ... –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë–æ–ª–µ–µ —è–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è webhook
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–∏—Ç—å rate limiting —Ç–æ–ª—å–∫–æ –¥–ª—è webhook
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤ –ª–æ–≥–∞—Ö
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –æ–±—â–∏–º location `/speq-bot`

### 2. –î–æ–±–∞–≤–ª–µ–Ω `client_max_body_size 10M`

Telegram –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –±–æ–ª—å—à–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, –¥–æ–∫—É–º–µ–Ω—Ç—ã). –£–≤–µ–ª–∏—á–µ–Ω –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞.

### 3. –î–æ–±–∞–≤–ª–µ–Ω `proxy_http_version 1.1`

–î–ª—è –≤—Å–µ—Ö location –±–ª–æ–∫–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω —è–≤–Ω—ã–π `proxy_http_version 1.1` –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

## üìã –ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–°–º. —Ñ–∞–π–ª `nginx.speq-full.conf` - –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è.

## üîí –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: Rate Limiting

–î–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å rate limiting:

1. –í `http` –±–ª–æ–∫ `nginx.conf` –¥–æ–±–∞–≤—å—Ç–µ:
```nginx
limit_req_zone $binary_remote_addr zone=telegram_limit:10m rate=10r/s;
```

2. –í location `/speq-bot/telegram/webhook` —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:
```nginx
limit_req zone=telegram_limit burst=20 nodelay;
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
sudo nginx -t

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx
sudo systemctl reload nginx

# –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook
npm run webhook:info

# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
curl -X POST https://botfix.ru/speq-bot/telegram/webhook \
  -H "Content-Type: application/json" \
  -d '{"test": true}'
```

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü–æ—Ä—è–¥–æ–∫ location –±–ª–æ–∫–æ–≤ –≤–∞–∂–µ–Ω**: –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ location –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã—à–µ –æ–±—â–∏—Ö
2. **–ó–∞–≤–µ—Ä—à–∞—é—â–∏–π —Å–ª–µ—à**: –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è
3. **–¢–∞–π–º–∞—É—Ç—ã**: 90s –¥–ª—è PROD –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ LLM –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è**: –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ Telegram

## üêõ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

–ï—Å–ª–∏ webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ nginx:
```bash
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Express —Å–µ—Ä–≤–µ—Ä–∞ (–¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã)

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—Ç—É:
```bash
netstat -tlnp | grep 7504
# –∏–ª–∏
ss -tlnp | grep 7504
```

4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:
```bash
./check-nginx-config.sh
```
