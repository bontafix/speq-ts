# Примеры Canonical параметров

## Что такое Canonical параметры

**Canonical** = нормализованная, стандартизированная форма параметров:
- ✅ ТОЛЬКО числа (number) или enum строки
- ✅ Стандартные единицы измерения
- ✅ Стандартные ключи из справочника
- ❌ Без единиц измерения в значениях
- ❌ Без вариаций названий
- ❌ Без текстовых описаний

---

## Пример 1: Числовые параметры

### Исходные данные (main_parameters)
```json
{
  "Мощность": "132 л.с.",
  "Рабочий вес": "13500 кг",
  "Общая макс. мощность": "97 кВт",
  "Производительность": "250 т/ч",
  "Макс. ширина укладки": "3.1 м",
  "Макс. толщина дорожного покрытия": "25 см"
}
```

### Нормализованные (normalized_parameters)
```json
{
  "power_hp": 132,
  "weight_kg": 13500,
  "power_kw": 97,
  "capacity_tph": 250,
  "max_width_m": 3.1,
  "max_thickness_cm": 25
}
```

**Что изменилось**:
- "Мощность": "132 л.с." → `power_hp: 132` (число, без единиц)
- "Рабочий вес": "13500 кг" → `weight_kg: 13500` (число, единица в ключе)
- "Общая макс. мощность": "97 кВт" → `power_kw: 97` (число, единица в ключе)
- "Производительность": "250 т/ч" → `capacity_tph: 250` (число, единица в ключе)
- "Макс. ширина укладки": "3.1 м" → `max_width_m: 3.1` (число, единица в ключе)
- "Макс. толщина дорожного покрытия": "25 см" → `max_thickness_cm: 25` (число, единица в ключе)

---

## Пример 2: Enum параметры

### Исходные данные (main_parameters)
```json
{
  "Тип питания": "Дизельный",
  "Тип рабочего органа": "Механическое уширение плиты",
  "Экологический класс": "Tier III"
}
```

### Нормализованные (normalized_parameters)
```json
{
  "fuel_type": "diesel",
  "working_organ_type": "mechanical_plate_expansion",
  "emission_class": "Tier III"
}
```

**Что изменилось**:
- "Тип питания": "Дизельный" → `fuel_type: "diesel"` (enum значение)
- "Тип рабочего органа": "Механическое уширение плиты" → `working_organ_type: "mechanical_plate_expansion"` (enum значение)
- "Экологический класс": "Tier III" → `emission_class: "Tier III"` (enum значение, уже стандартное)

---

## Пример 3: Смешанные параметры (полный пример)

### Исходные данные (main_parameters)
```json
{
  "Мощность": "132 л.с.",
  "Рабочий вес": "13500 кг",
  "Тип питания": "Дизельный",
  "Режим нагрева": "Электрический нагрев плиты",
  "Транс. размеры": "6300×2100×3030 мм",
  "Модель двигателя": "DONGFENG CUMMINS QSB4.5",
  "Рабочая скорость": "1,5~30 м/мин",
  "Частота Вибрации": "0～25 Гц",
  "Производительность": "250 т/ч",
  "Макс. ширина укладки": "3.1 м",
  "Общая макс. мощность": "97 кВт",
  "Экологический класс": "Tier III",
  "Преодолеваемый уклон": "≥20％",
  "Номинальная амплитуда": "4 мм",
  "Вес при транспортировке": "13500 кг",
  "Скорость движения вперед": "0~2,8 км/ч"
}
```

### Нормализованные (normalized_parameters)
```json
{
  "power_hp": 132,
  "weight_kg": 13500,
  "power_kw": 97,
  "fuel_type": "diesel",
  "capacity_tph": 250,
  "max_width_m": 3.1,
  "emission_class": "Tier III",
  "transport_weight_kg": 13500,
  "max_slope_percent": 20,
  "amplitude_mm": 4,
  "forward_speed_kmh": 2.8
}
```

**Что попало в normalized_parameters**:
- ✅ Числовые параметры с единицами → числа
- ✅ Enum параметры → стандартные enum значения

**Что НЕ попало** (осталось в main_parameters):
- ❌ "Режим нагрева": "Электрический нагрев плиты" (не критично для поиска)
- ❌ "Транс. размеры": "6300×2100×3030 мм" (сложная структура, не нормализуем)
- ❌ "Модель двигателя": "DONGFENG CUMMINS QSB4.5" (текст, не нормализуем)
- ❌ "Рабочая скорость": "1,5~30 м/мин" (диапазон, можно разбить на min/max, но пока не нормализуем)
- ❌ "Частота Вибрации": "0～25 Гц" (диапазон, не критично)

---

## Пример 4: Экскаватор (спецтехника)

### Исходные данные (main_parameters)
```json
{
  "тоннаж": 20,
  "объём_ковша": "1.2 м³",
  "мощность": "121 кВт",
  "глубина_копания": "6.5 м",
  "тип": "гусеничный"
}
```

### Нормализованные (normalized_parameters)
```json
{
  "weight_kg": 20000,
  "bucket_volume_m3": 1.2,
  "power_kw": 121,
  "dig_depth_m": 6.5,
  "drive_type": "crawler"
}
```

**Преобразования**:
- "тоннаж": 20 → `weight_kg: 20000` (тонны → килограммы)
- "объём_ковша": "1.2 м³" → `bucket_volume_m3: 1.2` (число, единица в ключе)
- "мощность": "121 кВт" → `power_kw: 121` (число, единица в ключе)
- "глубина_копания": "6.5 м" → `dig_depth_m: 6.5` (число, единица в ключе)
- "тип": "гусеничный" → `drive_type: "crawler"` (enum значение)

---

## Пример 5: Enum значения (детально)

### Тип питания (fuel_type)

**Исходные варианты**:
- "Дизельный"
- "дизель"
- "Diesel"
- "Дизельное топливо"

**Canonical значение**:
```json
{
  "fuel_type": "diesel"
}
```

**Справочник enum_values**:
```json
{
  "diesel": "дизель",
  "petrol": "бензин",
  "electric": "электрический",
  "hybrid": "гибридный"
}
```

### Тип хода (drive_type)

**Исходные варианты**:
- "гусеничный"
- "Гусеничный"
- "crawler"
- "гусеничный ход"

**Canonical значение**:
```json
{
  "drive_type": "crawler"
}
```

**Справочник enum_values**:
```json
{
  "crawler": "гусеничный",
  "wheeled": "колёсный",
  "track": "гусеничный"
}
```

---

## Пример 6: Диапазоны значений

### Исходные данные с диапазонами
```json
{
  "Рабочая скорость": "1,5~30 м/мин",
  "Частота Вибрации": "0～25 Гц",
  "Преодолеваемый уклон": "≥20％"
}
```

### Варианты нормализации

**Вариант 1: Только максимальное значение**
```json
{
  "working_speed_max_mmin": 30,
  "vibration_frequency_max_hz": 25,
  "max_slope_percent": 20
}
```

**Вариант 2: Минимальное и максимальное**
```json
{
  "working_speed_min_mmin": 1.5,
  "working_speed_max_mmin": 30,
  "vibration_frequency_min_hz": 0,
  "vibration_frequency_max_hz": 25,
  "max_slope_percent": 20
}
```

**Рекомендация**: Использовать вариант 2, если диапазон важен для поиска. Если нет — только максимальное значение.

---

## Пример 7: Единицы измерения (конверсия)

### Масса/вес

**Исходные варианты**:
- "20 тонн" → `weight_kg: 20000`
- "20000 кг" → `weight_kg: 20000`
- "20 т" → `weight_kg: 20000`
- "13500 кг" → `weight_kg: 13500`

**Правило**: Всегда приводить к килограммам (кг)

### Мощность

**Исходные варианты**:
- "132 л.с." → `power_hp: 132` (лошадиные силы)
- "97 кВт" → `power_kw: 97` (киловатты)
- "132 HP" → `power_hp: 132`

**Правило**: Хранить в обеих единицах, если есть оба значения, или в той, что указана

### Длина/размеры

**Исходные варианты**:
- "6.5 м" → `dig_depth_m: 6.5` (метры)
- "25 см" → `max_thickness_cm: 25` (сантиметры)
- "3.1 м" → `max_width_m: 3.1` (метры)

**Правило**: Хранить в метрах для больших значений, в см/мм для малых

---

## Правила нормализации

### ✅ ДОЛЖНО быть в normalized_parameters

1. **Числовые параметры** с единицами измерения:
   - Масса, вес → `weight_kg` (число)
   - Мощность → `power_hp` или `power_kw` (число)
   - Размеры → `*_m`, `*_cm`, `*_mm` (число)
   - Производительность → `capacity_*` (число)

2. **Enum параметры** (категориальные):
   - Тип питания → `fuel_type: "diesel" | "petrol" | "electric"`
   - Тип хода → `drive_type: "crawler" | "wheeled"`
   - Экологический класс → `emission_class: "Tier II" | "Tier III"`

### ❌ НЕ должно быть в normalized_parameters

1. **Текстовые описания**:
   - "Режим нагрева": "Электрический нагрев плиты"
   - "Модель двигателя": "DONGFENG CUMMINS QSB4.5"

2. **Сложные структуры**:
   - "Транс. размеры": "6300×2100×3030 мм" (можно разбить на length/width/height, но не обязательно)

3. **Нестандартные единицы**:
   - Если единица не определена в справочнике → не нормализуем

4. **Неизвестные параметры**:
   - Если параметр не в справочнике `parameter_dictionary` → не нормализуем

---

## Сравнение: до и после

### До нормализации (main_parameters)
```json
{
  "Мощность": "132 л.с.",
  "Рабочий вес": "13500 кг",
  "Тип питания": "Дизельный"
}
```

**Проблемы**:
- ❌ Нельзя сделать SQL-фильтр: `WHERE мощность > 100` (строка, не число)
- ❌ Нельзя сравнить: "132 л.с." vs "97 кВт" (разные единицы)
- ❌ Нельзя использовать индекс для числовых значений

### После нормализации (normalized_parameters)
```json
{
  "power_hp": 132,
  "weight_kg": 13500,
  "fuel_type": "diesel"
}
```

**Преимущества**:
- ✅ SQL-фильтр: `WHERE (normalized_parameters->>'power_hp')::numeric > 100`
- ✅ Можно сравнить: `power_hp` и `power_kw` (оба числа)
- ✅ Индекс работает: B-Tree индекс на числовых значениях
- ✅ Быстрый поиск: GIN индекс на JSONB

---

## Итоговая структура normalized_parameters

```typescript
interface NormalizedParameters {
  // Числовые параметры (всегда числа, единица в ключе)
  weight_kg?: number;
  power_hp?: number;
  power_kw?: number;
  capacity_tph?: number;
  dig_depth_m?: number;
  max_width_m?: number;
  max_thickness_cm?: number;
  bucket_volume_m3?: number;
  
  // Enum параметры (стандартные строковые значения)
  fuel_type?: "diesel" | "petrol" | "electric" | "hybrid";
  drive_type?: "crawler" | "wheeled";
  emission_class?: "Tier II" | "Tier III" | "Tier IV";
  
  // Диапазоны (опционально)
  working_speed_min_mmin?: number;
  working_speed_max_mmin?: number;
}
```

**Ключевые принципы**:
1. ТОЛЬКО числа и enum строки
2. Единица измерения в ключе (`_kg`, `_kw`, `_m`)
3. Стандартные ключи из справочника
4. Никаких текстовых описаний
5. Никаких единиц в значениях

