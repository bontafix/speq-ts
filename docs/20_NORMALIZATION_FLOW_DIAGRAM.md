# Диаграмма потока нормализации параметров

## Текущий поток (с дублированием)

```
┌─────────────────────────────────────────────────────────────────────┐
│ ПОЛЬЗОВАТЕЛЬ / LLM                                                   │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 │ Запрос
                                 ▼
         ┌───────────────────────────────────────────┐
         │    SearchEngine.search()                  │
         └───────────────┬───────────────────────────┘
                         │
                         │ query.parameters =
                         │ { "Мощность_min": "100 л.с.",
                         │   "Рабочий вес_max": "25000 кг" }
                         │
                         ▼
         ┌───────────────────────────────────────────┐
         │ QueryParameterNormalizer.normalizeQuery() │ ◄─── НОРМАЛИЗАЦИЯ #1
         └───────────────┬───────────────────────────┘
                         │
          ┌──────────────┼──────────────┐
          │              │              │
          ▼              ▼              ▼
    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │ regular │    │   min   │    │   max   │
    │ params  │    │ params  │    │ params  │
    └────┬────┘    └────┬────┘    └────┬────┘
         │              │              │
         │   {"Тип      │  {"Мощность" │  {"Рабочий
         │   питания":  │  : "100      │  вес":
         │   "Дизель"}  │  л.с."}      │  "25000 кг"}
         │              │              │
         ▼              ▼              ▼
    ┌──────────────────────────────────────┐
    │ ParameterNormalizerService.normalize()│
    └───────────────┬──────────────────────┘
                    │
         ┌──────────┼──────────┐
         │          │          │
         ▼          ▼          ▼
    ┌────────┐ ┌────────┐ ┌────────┐
    │Dictionary│UnitParser│EnumMapper│
    │Service  │         │         │
    └────┬───┘ └────┬───┘ └────┬───┘
         │          │          │
         └──────────┼──────────┘
                    │
                    ▼
         ┌────────────────────┐
         │  normalized params │
         │  { "power_hp": 100,│
         │    "weight_kg":    │
         │    25000,          │
         │    "fuel_type":    │
         │    "diesel" }      │
         └──────────┬─────────┘
                    │
                    │ Добавление суффиксов
                    ▼
         ┌────────────────────┐
         │ normalizedQuery    │
         │ parameters = {     │
         │  "power_hp_min": 100│
         │  "weight_kg_max":  │
         │  25000,            │
         │  "fuel_type":      │
         │  "diesel"          │
         │ }                  │
         └──────────┬─────────┘
                    │
                    │ ✅ ПАРАМЕТРЫ НОРМАЛИЗОВАНЫ
                    ▼
         ┌────────────────────────────────────────┐
         │ EquipmentRepository.fullTextSearch()   │
         └──────────┬─────────────────────────────┘
                    │
                    │ for (key, value) in parameters
                    │
                    ▼
         ┌────────────────────────────────────────┐
         │ normalizeParameter(key, value)         │ ◄─── ⚠️ НОРМАЛИЗАЦИЯ #2
         └──────────┬─────────────────────────────┘      (ДУБЛИРОВАНИЕ!)
                    │
         ┌──────────┼──────────┐
         │          │          │
         ▼          ▼          ▼
    ┌────────┐ ┌────────┐ ┌────────┐
    │Dictionary│UnitParser│Fallback│
    │Service  │         │Mapper   │
    │(снова!) │(снова!) │         │
    └────┬───┘ └────┬───┘ └────┬───┘
         │          │          │
         └──────────┼──────────┘
                    │
                    ▼
         ┌────────────────────────┐
         │  Построение SQL WHERE  │
         └────────────┬───────────┘
                      │
                      ▼
         ┌────────────────────────────────────┐
         │ WHERE                               │
         │  (main_parameters->>'power_hp')    │
         │    ::numeric >= $1                 │
         │  AND                               │
         │  (main_parameters->>'weight_kg')   │
         │    ::numeric <= $2                 │
         │  AND                               │
         │  main_parameters->>'fuel_type'     │
         │    = $3::text                      │
         └────────────┬───────────────────────┘
                      │
                      ▼
         ┌────────────────────────┐
         │   PostgreSQL Query     │
         └────────────┬───────────┘
                      │
                      ▼
         ┌────────────────────────┐
         │   Результаты поиска    │
         └────────────────────────┘
```

## Рекомендуемый поток (без дублирования)

```
┌─────────────────────────────────────────────────────────────────────┐
│ ПОЛЬЗОВАТЕЛЬ / LLM                                                   │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 │ Запрос
                                 ▼
         ┌───────────────────────────────────────────┐
         │    SearchEngine.search()                  │
         └───────────────┬───────────────────────────┘
                         │
                         │ query.parameters =
                         │ { "Мощность_min": "100 л.с.",
                         │   "Рабочий вес_max": "25000 кг" }
                         │
                         ▼
         ┌───────────────────────────────────────────┐
         │ QueryParameterNormalizer.normalizeQuery() │ ◄─── ЕДИНСТВЕННАЯ
         └───────────────┬───────────────────────────┘      НОРМАЛИЗАЦИЯ
                         │
          ┌──────────────┼──────────────┐
          │              │              │
          ▼              ▼              ▼
    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │ regular │    │   min   │    │   max   │
    │ params  │    │ params  │    │ params  │
    └────┬────┘    └────┬────┘    └────┬────┘
         │              │              │
         ▼              ▼              ▼
    ┌──────────────────────────────────────┐
    │ ParameterNormalizerService.normalize()│
    └───────────────┬──────────────────────┘
                    │
         ┌──────────┼──────────┐
         │          │          │
         ▼          ▼          ▼
    ┌────────┐ ┌────────┐ ┌────────┐
    │Dictionary│UnitParser│EnumMapper│
    │Service  │         │         │
    └────┬───┘ └────┬───┘ └────┬───┘
         │          │          │
         └──────────┼──────────┘
                    │
                    ▼
         ┌────────────────────┐
         │ normalizedQuery    │
         │ parameters = {     │
         │  "power_hp_min": 100│
         │  "weight_kg_max":  │
         │  25000,            │
         │  "fuel_type":      │
         │  "diesel"          │
         │ }                  │
         │ _normalized: true  │ ◄─── Флаг нормализации
         └──────────┬─────────┘
                    │
                    │ ✅ ПАРАМЕТРЫ НОРМАЛИЗОВАНЫ
                    ▼
         ┌────────────────────────────────────────┐
         │ EquipmentRepository.fullTextSearch()   │
         └──────────┬─────────────────────────────┘
                    │
                    │ if (query._normalized)
                    │    ✅ Пропустить нормализацию
                    │ else
                    │    ⚠️ Применить fallback
                    │
                    ▼
         ┌────────────────────────────────────────┐
         │  Построение SQL WHERE                  │
         │  (параметры УЖЕ canonical)             │
         └────────────┬───────────────────────────┘
                      │
                      │ for (key, value) in parameters:
                      │   if key.endsWith('_min'):
                      │     operator = '>='
                      │     paramKey = key.slice(0, -4)
                      │   elif key.endsWith('_max'):
                      │     operator = '<='
                      │     paramKey = key.slice(0, -4)
                      │   else:
                      │     operator = '='
                      │     paramKey = key
                      │
                      ▼
         ┌────────────────────────────────────┐
         │ WHERE                               │
         │  (main_parameters->>'power_hp')    │
         │    ::numeric >= $1                 │
         │  AND                               │
         │  (main_parameters->>'weight_kg')   │
         │    ::numeric <= $2                 │
         │  AND                               │
         │  main_parameters->>'fuel_type'     │
         │    = $3::text                      │
         └────────────┬───────────────────────┘
                      │
                      ▼
         ┌────────────────────────┐
         │   PostgreSQL Query     │
         └────────────┬───────────┘
                      │
                      ▼
         ┌────────────────────────┐
         │   Результаты поиска    │
         └────────────────────────┘
```

## Ключевые отличия

| Аспект | Текущий поток | Рекомендуемый поток |
|--------|---------------|---------------------|
| **Нормализация** | Дважды (SearchEngine + Repository) | Один раз (только SearchEngine) |
| **Обращение к словарю** | 2 раза | 1 раз |
| **Парсинг единиц** | 2 раза | 1 раз |
| **Производительность** | Ниже | Выше |
| **Сложность кода** | Выше (дублирование) | Ниже (проще) |
| **Контракт** | Неявный | Явный (флаг _normalized) |
| **Fallback** | Всегда активен | Только при необходимости |

## Пример изменений в коде

### Текущий код (EquipmentRepository)

```typescript
// ❌ ПРОБЛЕМА: Повторная нормализация
for (const [key, value] of Object.entries(query.parameters)) {
  const normalized = this.normalizeParameter(key, value);  // ⚠️ Избыточно!
  
  if (!normalized) continue;
  
  const { paramKey, value: normalizedValue, operator, sqlCast } = normalized;
  
  whereParts.push(
    `(main_parameters->>$${keyIndex})${sqlCast} ${operator} $${valueIndex}`
  );
}
```

### Рекомендуемый код

```typescript
// ✅ РЕШЕНИЕ: Параметры уже нормализованы
for (const [key, value] of Object.entries(query.parameters)) {
  // Параметры уже в canonical формате (power_hp_min, weight_kg_max)
  let operator: '=' | '>=' | '<=' = '=';
  let sqlCast = typeof value === 'number' ? '::numeric' : '::text';
  let paramKey = key;

  // Определяем оператор из суффикса
  if (key.endsWith('_min')) {
    operator = '>=';
    sqlCast = '::numeric';
    paramKey = key.slice(0, -4);
  } else if (key.endsWith('_max')) {
    operator = '<=';
    sqlCast = '::numeric';
    paramKey = key.slice(0, -4);
  }

  // Валидация
  if (!this.validateParameterKey(paramKey)) {
    console.warn(`[Security] Invalid parameter key: ${paramKey}`);
    continue;
  }

  // Добавляем условие
  values.push(paramKey, value);
  whereParts.push(
    `(main_parameters->>$${values.length - 1})${sqlCast} ${operator} $${values.length}`
  );
}
```

## Преимущества рекомендуемого подхода

1. **✅ Производительность**
   - Одно обращение к БД для загрузки словаря
   - Один проход парсинга единиц измерения
   - Один проход маппинга enum значений

2. **✅ Простота**
   - Четкое разделение ответственности
   - Меньше кода в Repository
   - Легче понять поток данных

3. **✅ Надежность**
   - Нет риска конфликта между двумя нормализациями
   - Единый источник правды (словарь)
   - Проще отлаживать

4. **✅ Масштабируемость**
   - Легче добавлять новые параметры
   - Легче менять логику нормализации
   - Все изменения в одном месте

## См. также

- `docs/16_QUERY_PARAMETER_NORMALIZATION.md` - Документация алгоритма
- `docs/19_NORMALIZATION_CHECK_RESULT.md` - Результаты проверки
- `docs/17_NORMALIZATION_ANALYSIS.md` - Детальный анализ

