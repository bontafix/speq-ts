# Фрагмент конфигурации nginx для добавления в существующий server блок
# Добавьте эти location блоки в ваш существующий server блок nginx
# для домена domain.com
# Путь: /speq-bot/webapp/api
#
# ВАЖНО: Порядок location блоков имеет значение!
# Более специфичные location должны быть ПЕРЕД общими.

# Редирект с /speq-bot/webapp/api/api-docs на /speq-bot/webapp/api/api-docs/ (с завершающим слешем)
# Это нужно, чтобы Swagger UI не делал свой редирект на /api-docs/
location = /speq-bot/webapp/api/api-docs {
    return 301 /speq-bot/webapp/api/api-docs/;
}

# Location для Swagger документации (должен быть ПЕРЕД общим location /speq-bot/webapp/api)
# Доступна по адресу: /speq-bot/webapp/api/api-docs/
# Обрабатывает все подпути Swagger UI (swagger.json, статические файлы и т.д.)
location ~ ^/speq-bot/webapp/api/api-docs(/.*)?$ {
    # Проксирование на локальный API сервер
    # Заменяем /speq-bot/webapp/api/api-docs на /api-docs
    # $1 содержит подпуть (например, /swagger-ui-bundle.js или пустая строка для /api-docs/)
    proxy_pass http://127.0.0.1:7505/api-docs$1;
    proxy_http_version 1.1;
    
    # Заголовки для правильной работы прокси
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Заменяем пути ТОЛЬКО в HTML ответе Swagger UI
    # Это нужно, чтобы Swagger UI использовал правильные пути и не делал редиректы на /api-docs/
    # ВАЖНО: sub_filter применяется только к HTML, не к статическим файлам (CSS/JS)
    sub_filter '"/api-docs/' '"/speq-bot/webapp/api/api-docs/';
    sub_filter "'/api-docs/" "'/speq-bot/webapp/api/api-docs/";
    sub_filter 'href="/api-docs/' 'href="/speq-bot/webapp/api/api-docs/';
    sub_filter "href='/api-docs/" "href='/speq-bot/webapp/api/api-docs/";
    sub_filter 'src="/api-docs/' 'src="/speq-bot/webapp/api/api-docs/';
    sub_filter "src='/api-docs/" "src='/speq-bot/webapp/api/api-docs/";
    # Заменяем относительные пути ./swagger-ui-* на абсолютные с правильным префиксом
    sub_filter 'href="./swagger-ui-' 'href="/speq-bot/webapp/api/api-docs/swagger-ui-';
    sub_filter "href='./swagger-ui-" "href='/speq-bot/webapp/api/api-docs/swagger-ui-";
    sub_filter 'src="./swagger-ui-' 'src="/speq-bot/webapp/api/api-docs/swagger-ui-';
    sub_filter "src='./swagger-ui-" "src='/speq-bot/webapp/api/api-docs/swagger-ui-";
    sub_filter_once off;
    # ВАЖНО: применяем sub_filter ТОЛЬКО к HTML, не к статическим файлам
    sub_filter_types text/html;
    
    # Включаем буферизацию (нужно для sub_filter)
    proxy_buffering on;
    
    # Стандартные таймауты
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# Location для Health check (должен быть ПЕРЕД общим location /speq-bot/webapp/api)
# Доступен по адресу: /speq-bot/webapp/api/health
location /speq-bot/webapp/api/health {
    # Проксирование на локальный API сервер
    # Завершающий слеш заменяет /speq-bot/webapp/api/health на /health при проксировании
    proxy_pass http://127.0.0.1:7505/health;
    proxy_http_version 1.1;
    
    # Заголовки для правильной работы прокси
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Включаем буферизацию
    proxy_buffering on;
    
    # Стандартные таймауты
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# Location для API веб-приложения на маршруте /speq-bot/webapp/api
# Проксирует запросы на локальный API сервер на порту 7505
location /speq-bot/webapp/api {
    # Переписываем путь: /speq-bot/webapp/api/equipment/1000 -> /api/equipment/1000
    rewrite ^/speq-bot/webapp/api(.*)$ /api$1 break;
    
    # Проксирование на локальный API сервер
    proxy_pass http://127.0.0.1:7505;
    proxy_http_version 1.1;
    
    # Заголовки для правильной работы прокси
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Включаем буферизацию для API (обычные REST запросы)
    proxy_buffering on;
    
    # Стандартные таймауты для API
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
    
    # Поддержка CORS (если нужно)
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    
    # Обработка OPTIONS запросов для CORS
    if ($request_method = OPTIONS) {
        return 204;
    }
}

# Location для Frontend веб-приложения на маршруте /speq-bot/webapp
# Проксирует запросы на локальный Vite dev сервер на порту 5173
# В продакшене здесь должен быть указан путь к собранным статическим файлам
location /speq-bot/webapp {
    # Для разработки: проксирование на Vite dev сервер
    # Vite настроен на base: /speq-bot/webapp/, поэтому пути совпадают
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    
    # Заголовки для правильной работы прокси
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Поддержка WebSocket для Vite HMR (Hot Module Replacement)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Отключаем буферизацию для WebSocket
    proxy_buffering off;
    
    # Таймауты для WebSocket соединений
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Поддержка SPA роутинга (Vue Router) - для dev режима
    # В продакшене используйте try_files (см. альтернативную конфигурацию ниже)
}

# Альтернативная конфигурация для продакшена (когда frontend собран)
# Раскомментируйте этот блок и закомментируйте предыдущий при деплое
# 
# location /speq-bot/webapp {
#     # Путь к собранным статическим файлам (замените на реальный путь)
#     alias /home/boris/dev/speq-ts/webapp/frontend/dist;
#     index index.html;
#     
#     # Поддержка SPA роутинга (Vue Router)
#     try_files $uri $uri/ /speq-bot/webapp/index.html;
#     
#     # Кэширование статических файлов
#     location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#     }
#     
#     # Не кэшировать index.html
#     location = /speq-bot/webapp/index.html {
#         add_header Cache-Control "no-cache, no-store, must-revalidate";
#     }
# }

############################
# ПРИМЕЧАНИЯ
############################
#
# 1. Порты:
#    - API сервер: 7505 (или WEBAPP_API_PORT из .env)
#    - Frontend dev сервер: 5173 (настраивается в vite.config.ts)
#
# 2. Доступные маршруты:
#    - Frontend: https://domain.com/speq-bot/webapp/equipment/{id}
#    - API: https://domain.com/speq-bot/webapp/api/equipment/{id}
#    - Swagger: https://domain.com/speq-bot/webapp/api/api-docs
#    - Health: https://domain.com/speq-bot/webapp/api/health
#
# 3. Для продакшена:
#    - Соберите frontend: cd webapp/frontend && npm run build
#    - Раскомментируйте альтернативный блок location /speq-bot/webapp выше
#    - Укажите правильный путь к dist папке
#
# 4. ВАЖНО: Этот конфиг предназначен для использования внутри /speq-bot
#    Для отдельного использования webapp используйте nginx.location.webapp.conf
