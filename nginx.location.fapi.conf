# Фрагмент конфигурации nginx для добавления в существующий server блок
# Добавьте эти location блоки в ваш существующий server блок nginx
# для домена botfix.ru
#
# ВАЖНО: Порядок location блоков имеет значение!
# Более специфичные location должны быть ПЕРЕД общими.

# Location для Swagger документации (должен быть ПЕРЕД общим location /speq-bot/fapi)
# Доступна по адресу: https://botfix.ru/speq-bot/fapi/api-docs
location ~ ^/speq-bot/fapi/api-docs(/.*)?$ {
    # Переписываем путь: /speq-bot/fapi/api-docs -> /api-docs
    rewrite ^/speq-bot/fapi/api-docs(.*)$ /api-docs$1 break;
    
    # Проксирование на локальный FAPI сервер
    proxy_pass http://127.0.0.1:3002;
    proxy_http_version 1.1;
    
    # Заголовки для правильной работы прокси
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Включаем буферизацию для Swagger
    proxy_buffering on;
    
    # Стандартные таймауты
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# Location для Health check (должен быть ПЕРЕД общим location /speq-bot/fapi)
# Доступен по адресу: https://botfix.ru/speq-bot/fapi/health
location ~ ^/speq-bot/fapi/health$ {
    # Переписываем путь: /speq-bot/fapi/health -> /health
    rewrite ^/speq-bot/fapi/health$ /health break;
    
    # Проксирование на локальный FAPI сервер
    proxy_pass http://127.0.0.1:3002;
    proxy_http_version 1.1;
    
    # Заголовки для правильной работы прокси
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Включаем буферизацию
    proxy_buffering on;
    
    # Стандартные таймауты
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# Location для FAPI на маршруте /speq-bot/fapi
# Проксирует запросы на локальный FAPI сервер на порту 3002
# Убираем /speq-bot/fapi из пути при проксировании (rewrite)
location /speq-bot/fapi {
    # Переписываем путь: /speq-bot/fapi/users -> /users
    rewrite ^/speq-bot/fapi(.*)$ $1 break;
    
    # Проксирование на локальный FAPI сервер
    proxy_pass http://127.0.0.1:3002;
    proxy_http_version 1.1;
    
    # Заголовки для правильной работы прокси
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Включаем буферизацию для API (обычные REST запросы)
    proxy_buffering on;
    
    # Стандартные таймауты для API
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
    
    # Поддержка CORS (если нужно)
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Credentials "true" always;
    
    # Обработка OPTIONS запросов для CORS
    if ($request_method = OPTIONS) {
        return 204;
    }
}

############################
# ПРИМЕЧАНИЯ
############################
#
# 1. Порты:
#    - FAPI сервер: 3002 (или FAPI_PORT из .env)
#
# 2. Доступные маршруты:
#    - API: https://botfix.ru/speq-bot/fapi/users
#    - API: https://botfix.ru/speq-bot/fapi/equipment
#    - Swagger: https://botfix.ru/speq-bot/fapi/api-docs
#    - Health: https://botfix.ru/speq-bot/fapi/health
#
# 3. Примеры использования:
#    - GET https://botfix.ru/speq-bot/fapi/users
#    - GET https://botfix.ru/speq-bot/fapi/equipment
#    - POST https://botfix.ru/speq-bot/fapi/auth/login
#
# 4. Для добавления в существующий server блок:
#    - Скопируйте location блоки выше в ваш server блок для botfix.ru
#    - Убедитесь, что более специфичные location идут перед общими
#    - Перезагрузите nginx: sudo nginx -t && sudo systemctl reload nginx
