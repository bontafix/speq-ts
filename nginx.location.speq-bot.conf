# Фрагмент конфигурации nginx для добавления в существующий server блок
# Добавьте этот location блок в ваш существующий server блок nginx
# для домена domain.com

# Location для speq-bot на маршруте /speq-bot
# Проксирует запросы на локальный сервер на порту 7504
# ВАЖНО: завершающий слеш в proxy_pass убирает префикс /speq-bot из пути
location /speq-bot {
    # Проксирование на локальный сервер
    # Завершающий слеш заменяет /speq-bot на / при проксировании
    # Запрос /speq-bot/telegram/webhook станет /telegram/webhook на бэкенде
    proxy_pass http://127.0.0.1:7504/;
    proxy_http_version 1.1;
    
    # Заголовки для правильной работы прокси
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Отключаем буферизацию для webhook (важно для быстрого ответа Telegram)
    proxy_buffering off;
    proxy_request_buffering off;
    
    # Увеличиваем таймауты для обработки обновлений (LLM может обрабатывать долго)
    proxy_connect_timeout 90s;
    proxy_send_timeout 90s;
    proxy_read_timeout 90s;
    
    # Поддержка WebSocket (если понадобится в будущем)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# Специальная настройка для webhook endpoint (опционально, для оптимизации)
# Если нужна отдельная настройка только для webhook
location /speq-bot/telegram/webhook {
    proxy_pass http://127.0.0.1:7504/telegram/webhook;
    proxy_http_version 1.1;
    
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Отключаем буферизацию для быстрого ответа
    proxy_buffering off;
    proxy_request_buffering off;
    
    # Увеличиваем таймауты для обработки обновлений
    proxy_connect_timeout 90s;
    proxy_send_timeout 90s;
    proxy_read_timeout 90s;
}
