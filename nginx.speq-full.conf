############################
# SPEQ BOT / DEV / STAGE
############################

# ВАЖНО: Порядок location блоков имеет значение!
# Более специфичные location должны быть ВЫШЕ общих

# === SPEQ BOT WEBHOOK (оптимизированная настройка для Telegram webhook) ===
# Специальный location для webhook с приоритетом над общим /speq-bot
# Должен быть ПЕРЕД location /speq-bot для правильного приоритета
# Telegram отправляет обновления на этот endpoint
location = /speq-bot/telegram/webhook {
    proxy_pass http://127.0.0.1:7504/telegram/webhook;
    proxy_http_version 1.1;

    # Заголовки для правильной работы прокси
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    # Отключаем буферизацию для быстрого ответа Telegram (критично!)
    proxy_buffering off;
    proxy_request_buffering off;

    # Увеличиваем таймауты для обработки обновлений (LLM может обрабатывать долго)
    proxy_connect_timeout 90s;
    proxy_send_timeout 90s;
    proxy_read_timeout 90s;

    # Размер тела запроса (Telegram может отправлять большие обновления с фото)
    client_max_body_size 10M;

    # Опционально: Rate limiting для защиты от злоупотреблений
    # Раскомментируйте, если настроили limit_req_zone в http блоке:
    # limit_req zone=telegram_limit burst=20 nodelay;
}

# === SPEQ BOT (PROD) ===
# Основной location для всех запросов к speq-bot
# Должен быть ПОСЛЕ более специфичных location
location /speq-bot {
    proxy_pass http://127.0.0.1:7504/;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    proxy_buffering off;
    proxy_request_buffering off;

    proxy_connect_timeout 90s;
    proxy_send_timeout 90s;
    proxy_read_timeout 90s;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# === SPEQ DEV ===
location /speq-dev/ {
    proxy_pass http://127.0.0.1:7502/;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Prefix /speq-dev;

    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    proxy_buffering off;
    proxy_request_buffering off;
}

# === SPEQ STAGE ===
location /speq-stage/ {
    proxy_pass http://127.0.0.1:7503/;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Prefix /speq-stage;

    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    proxy_buffering off;
    proxy_request_buffering off;
}

############################
# SPEQ IMAGES
############################

location /speq-images/ {
    # /speq-images/1000
    location ~ ^/speq-images/(\d+)$ {
        alias /home/boris/dev/speq-ts/images/$1/;
        try_files 0.png 0.jpg =404;

        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # /speq-images/1000/50
    location ~ ^/speq-images/(\d+)/(\d+)$ {
        alias /home/boris/dev/speq-ts/images/$1/;
        try_files 0-$2.png 0-$2.jpg =404;

        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # всё остальное запрещаем
    return 404;
}

############################
# ОПЦИОНАЛЬНО: Rate Limiting для Telegram Webhook
############################
# Добавьте в http блок nginx.conf (не в server блок):
#
# limit_req_zone $binary_remote_addr zone=telegram_limit:10m rate=10r/s;
#
# Затем раскомментируйте строку limit_req в location /speq-bot/telegram/webhook выше
