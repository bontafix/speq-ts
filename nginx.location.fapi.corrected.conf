############################
# SPEQ Fastify API (TypeScript)
# Должен быть подключен через include в server блок botfix.conf
# Слушает порт 7506 (или FAPI_PORT из .env)
# Базовый путь: /speq-bot/fapi
############################

# ВАЖНО: Порядок location блоков имеет значение!
# Более специфичные location должны быть ВЫШЕ общих

# === Health Check (самый специфичный) ===
# Доступно по: https://botfix.ru/speq-bot/fapi/health
location = /speq-bot/fapi/health {
    # Переписываем путь: /speq-bot/fapi/health -> /health
    rewrite ^/speq-bot/fapi/health$ /health break;
    
    proxy_pass http://127.0.0.1:7506;
    proxy_http_version 1.1;
    
    # Минимальные заголовки для health check
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    
    # Отключаем ненужные заголовки для health check
    proxy_hide_header X-Powered-By;
    
    # Быстрые таймауты для health check
    proxy_connect_timeout 3s;
    proxy_send_timeout 3s;
    proxy_read_timeout 3s;
    
    # Отключаем буферизацию для быстрого ответа
    proxy_buffering off;
    proxy_request_buffering off;
    
    # Отключаем логирование health check (опционально)
    access_log off;
}

# === Fastify Swagger документация ===
# Fastify-swagger-ui использует /api-docs (не /documentation!)
# Доступно по: https://botfix.ru/speq-bot/fapi/api-docs
location ~ ^/speq-bot/fapi/api-docs(/.*)?$ {
    # Переписываем путь: /speq-bot/fapi/api-docs -> /api-docs
    rewrite ^/speq-bot/fapi/api-docs(.*)$ /api-docs$1 break;
    
    proxy_pass http://127.0.0.1:7506;
    proxy_http_version 1.1;
    
    # Заголовки для правильной работы прокси
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Скрываем заголовки Fastify
    proxy_hide_header X-Powered-By;
    
    # Включаем буферизацию
    proxy_buffering on;
    
    # Таймауты для документации
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
    
    # Исправление относительных путей в Swagger UI
    # Fastify-swagger-ui может использовать относительные пути
    sub_filter 'href="/' 'href="/speq-bot/fapi/';
    sub_filter 'src="/' 'src="/speq-bot/fapi/';
    sub_filter 'url: "/' 'url: "/speq-bot/fapi/';
    sub_filter_once off;
    sub_filter_types text/html application/javascript;
}

# === OpenAPI JSON схема ===
# Обычно доступна по /api-docs/json или через Swagger UI
location ~ ^/speq-bot/fapi/api-docs/json$ {
    rewrite ^/speq-bot/fapi/api-docs/json$ /api-docs/json break;
    
    proxy_pass http://127.0.0.1:7506;
    proxy_http_version 1.1;
    
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Кэширование JSON схемы
    expires 1h;
    add_header Cache-Control "public, must-revalidate";
    
    proxy_buffering on;
    proxy_connect_timeout 10s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
}

# === WebSocket поддержка для Fastify (если используется) ===
# Fastify использует websocket через @fastify/websocket
location ~ ^/speq-bot/fapi/ws(/.*)?$ {
    rewrite ^/speq-bot/fapi/ws(.*)$ /ws$1 break;
    
    proxy_pass http://127.0.0.1:7506;
    proxy_http_version 1.1;
    
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    
    # WebSocket заголовки
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Отключаем буферизацию для WebSocket
    proxy_buffering off;
    proxy_request_buffering off;
    
    # Длинные таймауты для WebSocket
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 3600s;  # Длинные подключения для WS
}

# === Основной API endpoint для Fastify ===
# Обрабатывает ВСЕ остальные запросы к /speq-bot/fapi
# КРИТИЧЕСКИ ВАЖНО: Fastify ожидает пути БЕЗ префикса /speq-bot/fapi
location /speq-bot/fapi {
    # ПЕРЕПИСЫВАЕМ путь: /speq-bot/fapi/users -> /users
    # БЕЗ этого rewrite Fastify получит /speq-bot/fapi/users вместо /users
    rewrite ^/speq-bot/fapi(.*)$ $1 break;
    
    # Проксируем на Fastify (после rewrite путь уже без префикса)
    proxy_pass http://127.0.0.1:7506;
    proxy_http_version 1.1;
    
    # Полный набор заголовков для Fastify
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Скрываем технические заголовки
    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;
    
    # Настройки буферизации для Fastify (оптимизировано)
    proxy_buffering on;
    proxy_buffer_size 16k;
    proxy_buffers 4 32k;
    proxy_busy_buffers_size 64k;
    
    # Fastify быстрый, можно уменьшить таймауты
    proxy_connect_timeout 15s;
    proxy_send_timeout 15s;
    proxy_read_timeout 30s;
    
    # Размер тела запроса
    client_max_body_size 10M;
    client_body_buffer_size 128k;
    
    # CORS заголовки (дополнительно к настройкам в Fastify)
    # Рекомендуется настроить CORS в самом Fastify через @fastify/cors
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS, HEAD" always;
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, X-API-Key" always;
    add_header Access-Control-Expose-Headers "Content-Length, Content-Range, X-Total-Count" always;
    add_header Access-Control-Max-Age 86400 always;
    
    # Обработка OPTIONS запросов для CORS (Preflight)
    if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS, HEAD";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, X-API-Key";
        add_header Access-Control-Max-Age 86400;
        add_header Content-Length 0;
        add_header Content-Type "text/plain; charset=utf-8";
        return 204;
    }
    
    # Rate limiting (раскомментируйте если нужно)
    # limit_req zone=fastify_api burst=20 nodelay;
    # limit_req_status 429;
    
    # Заголовки безопасности
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Логирование
    access_log /var/log/nginx/speq-fapi-access.log combined buffer=32k flush=5s;
    error_log /var/log/nginx/speq-fapi-error.log warn;
    
    # Обработка ошибок
    proxy_intercept_errors on;
    error_page 400 401 402 403 404 405 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 425 426 428 429 431 451 = @fastify_error;
    error_page 500 501 502 503 504 505 506 507 508 510 511 = @fastify_error;
}

# === Обработчик ошибок для Fastify ===
location @fastify_error {
    # Fastify обычно возвращает JSON ошибки
    # Проксируем как есть
    proxy_pass http://127.0.0.1:7506;
    proxy_intercept_errors off;
    
    add_header Content-Type "application/json" always;
    
    # Короткие таймауты для обработки ошибок
    proxy_connect_timeout 3s;
    proxy_send_timeout 3s;
    proxy_read_timeout 3s;
}

############################
# НАСТРОЙКИ ДЛЯ HTTP БЛОКА (nginx.conf)
# Добавьте в http блок nginx.conf если нужно
############################

# Для rate limiting (раскомментируйте если нужно):
# limit_req_zone $binary_remote_addr zone=fastify_api:10m rate=100r/m;

############################
# КРИТИЧЕСКИ ВАЖНЫЕ ИСПРАВЛЕНИЯ
############################

# 1. ✅ ИСПРАВЛЕНО: Добавлен rewrite в основном location блоке
#    БЕЗ rewrite Fastify получал бы /speq-bot/fapi/users вместо /users
#
# 2. ✅ ИСПРАВЛЕНО: Swagger путь изменен с /documentation на /api-docs
#    (соответствует настройкам в swagger.ts)
#
# 3. ✅ ИСПРАВЛЕНО: Удален дублирующий proxy_read_timeout в WebSocket location
#
# 4. ✅ ИСПРАВЛЕНО: Удален нестандартный заголовок X-Forwarded-Path
#
# 5. ✅ Порт 7506 - убедитесь что он соответствует FAPI_PORT в .env

############################
# НАСТРОЙКИ ДЛЯ FASTIFY ПРИЛОЖЕНИЯ
############################

# 1. Настройте trustProxy в Fastify приложении (src/app.ts):
#    const app = Fastify({
#        trustProxy: true,  // Доверять заголовкам X-Forwarded-*
#        logger: loggerConfig,
#    })
#
#    Это критически важно для правильной работы с прокси!

# 2. CORS уже настроен в src/core/plugins/cors.ts, но можно уточнить:
#    await fastify.register(cors, {
#        origin: ['https://botfix.ru'],  // Укажите конкретные домены
#        credentials: true,
#    })

# 3. Настройки для Fastify на порту 7506 (или FAPI_PORT):
#    В .env файле:
#    FAPI_PORT=7506
#    FAPI_HOST=127.0.0.1  # Только локально для безопасности!
#
#    Или в src/server.ts:
#    await app.listen({
#        port: config.port,  // 7506
#        host: '127.0.0.1'  // Только локально!
#    })

# 4. Health check endpoint уже настроен в src/modules/health/index.ts
#    Доступен по: /health

############################
# ИНСТРУКЦИЯ ПО УСТАНОВКЕ
############################

# 1. Создайте файл:
#    sudo nano /etc/nginx/sites-available/botfix-speq-fapi.conf

# 2. Вставьте этот конфиг

# 3. Добавьте в botfix.conf в server блок:
#    include /etc/nginx/sites-available/botfix-speq-fapi.conf;

# 4. Обновите Fastify приложение:
#    - Добавьте trustProxy: true в src/app.ts
#    - Убедитесь что FAPI_PORT=7506 в .env

# 5. Проверьте и перезагрузите:
#    sudo nginx -t
#    sudo systemctl reload nginx

# 6. Проверьте работу:
#    curl https://botfix.ru/speq-bot/fapi/health
#    curl https://botfix.ru/speq-bot/fapi/users
