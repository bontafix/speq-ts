# Как работает поиск по параметрам

## Быстрый запуск

```bash
# Показать демонстрацию (без БД)
npx tsx src/scripts/show-parameter-search-flow.ts
```

## Простой пример

### Запрос от пользователя
```json
{
  "text": "экскаватор",
  "parameters": {
    "Мощность": "132 л.с.",
    "Рабочий вес": "13500 кг"
  }
}
```

### Что происходит

**1. Нормализация параметров**
```
"Мощность": "132 л.с."  
  ↓ [Словарь параметров]
  ↓ [UnitParser]
"power_hp": 132

"Рабочий вес": "13500 кг"
  ↓ [Словарь параметров]
  ↓ [UnitParser]  
"weight_kg": 13500
```

**2. SQL запрос**
```sql
SELECT id, name, category, brand, price, main_parameters
FROM equipment
WHERE is_active = true
  AND search_vector @@ plainto_tsquery('russian', 'экскаватор')
  AND (main_parameters->>'power_hp')::numeric = 132
  AND (main_parameters->>'weight_kg')::numeric = 13500
ORDER BY ts_rank(...) DESC
LIMIT 10;
```

**3. Результаты**
```
✅ Найдено: 5 единиц оборудования

1. LIEBHERR R944C
   Мощность: 132 л.с.
   Вес: 13500 кг
```

## Диапазоны (_min, _max)

### Запрос
```json
{
  "parameters": {
    "Мощность_min": "100 л.с.",
    "Мощность_max": "200 л.с.",
    "Рабочий вес_min": "10000 кг"
  }
}
```

### Нормализация
```
"Мощность_min" → "power_hp_min": 100
"Мощность_max" → "power_hp_max": 200
"Рабочий вес_min" → "weight_kg_min": 10000
```

### SQL
```sql
WHERE (main_parameters->>'power_hp')::numeric >= 100    -- _min → >=
  AND (main_parameters->>'power_hp')::numeric <= 200    -- _max → <=
  AND (main_parameters->>'weight_kg')::numeric >= 10000 -- _min → >=
```

## Конверсия единиц

### Поддерживаемые единицы

**Мощность:**
- л.с. (hp) ↔ кВт (kw) ↔ Вт (w)

**Масса:**
- тонны (t) ↔ кг (kg) ↔ г (g)

**Длина:**
- км (km) ↔ м (m) ↔ см (cm) ↔ мм (mm)

**Объем:**
- м³ (m3) ↔ л (l)

### Примеры

```json
{
  "Мощность": "97 кВт"      // → power_kw: 97 (или power_hp: 132)
  "Масса": "20 тонн"        // → weight_kg: 20000
  "Высота подъема": "6 м"   // → lifting_height_mm: 6000
}
```

## Поток данных

```
┌─────────────────────────┐
│ Запрос от LLM           │
│ { "Мощность": "100 л.с."}│
└────────────┬────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ QueryParameterNormalizer            │
│ - Разделение по суффиксам (_min/_max)│
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ ParameterNormalizerService          │
│ - Поиск в словаре                   │
│ - UnitParser (конверсия единиц)     │
│ - EnumMapper (маппинг enum)         │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────┐
│ Нормализованный запрос  │
│ { "power_hp": 100 }     │
└────────────┬────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ EquipmentRepository                 │
│ - Построение SQL WHERE              │
│ - Выполнение запроса к PostgreSQL   │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────┐
│ Результаты поиска       │
└─────────────────────────┘
```

## Компоненты

### 1. QueryParameterNormalizer
**Файл:** `src/normalization/query-parameter-normalizer.ts`

Разделяет параметры по суффиксам и координирует нормализацию:
```typescript
const normalizer = new QueryParameterNormalizer(dictionaryService);
const result = normalizer.normalizeQuery(query);
```

### 2. ParameterDictionaryService
**Файл:** `src/normalization/parameter-dictionary.service.ts`

Загружает словарь из БД и ищет canonical ключи:
```typescript
await dictionaryService.loadDictionary();
const paramDef = dictionaryService.findCanonicalKey('Мощность');
// → { key: 'power_hp', param_type: 'number', unit: 'hp', ... }
```

### 3. UnitParser
**Файл:** `src/normalization/unit-parser.ts`

Парсит и конвертирует единицы измерения:
```typescript
const parser = new UnitParser();
parser.parseValue('20 тонн', 'kg');  // → 20000
parser.parseValue('97 кВт', 'hp');   // → 132 (конверсия)
```

### 4. EnumMapper
**Файл:** `src/normalization/enum-mapper.ts`

Маппит текстовые значения в canonical:
```typescript
const mapper = new EnumMapper();
mapper.mapEnumValue('Дизельный', paramDef);  // → 'diesel'
```

### 5. EquipmentRepository
**Файл:** `src/repository/equipment.repository.ts`

Строит SQL запросы с нормализованными параметрами.

## Примеры запросов

### 1. Простой поиск
```json
{
  "text": "экскаватор",
  "parameters": {
    "Мощность": "100 л.с."
  }
}
```

### 2. Диапазон мощности
```json
{
  "text": "экскаватор",
  "parameters": {
    "Мощность_min": "100 л.с.",
    "Мощность_max": "200 л.с."
  }
}
```

### 3. Комбинированный фильтр
```json
{
  "category": "Краны",
  "brand": "LIEBHERR",
  "parameters": {
    "Грузоподъемность_min": "10 тонн",
    "Высота подъема_max": "50 м"
  }
}
```

### 4. Множественные параметры
```json
{
  "text": "погрузчик",
  "parameters": {
    "Мощность_min": "150 л.с.",
    "Грузоподъемность_min": "5000 кг",
    "Рабочий вес_max": "25000 кг",
    "Тип питания": "Дизельный"
  }
}
```

## SQL операторы

| Суффикс | SQL оператор | Описание |
|---------|--------------|----------|
| (нет) | `=` | Точное совпадение |
| `_min` | `>=` | Больше или равно |
| `_max` | `<=` | Меньше или равно |

## Типы параметров

### number
```json
{
  "Мощность": "132 л.с.",
  "Вес": "13500 кг",
  "Высота": "3.5 м"
}
```

### enum
```json
{
  "Тип питания": "Дизельный",    // → "diesel"
  "Привод": "Полноприводный"     // → "4wd"
}
```

### boolean
```json
{
  "Кондиционер": "да",           // → true
  "Гидромолот": "нет"            // → false
}
```

## Отладка

### Включить DEBUG режим
```bash
DEBUG=1 npm run start
```

### Проверить нормализацию
```bash
npx tsx src/scripts/test-normalization-logic.ts
```

### Показать поток
```bash
npx tsx src/scripts/show-parameter-search-flow.ts
```

## Документация

**Полная документация:**
- `docs/16_QUERY_PARAMETER_NORMALIZATION.md` - Детальное описание алгоритма
- `docs/19_NORMALIZATION_CHECK_RESULT.md` - Результаты проверки
- `docs/20_NORMALIZATION_FLOW_DIAGRAM.md` - Визуальные диаграммы

**Проверка реализации:**
- `ПРОВЕРКА_НОРМАЛИЗАЦИИ.md` - Краткие результаты проверки

**Код:**
- `src/normalization/` - Все компоненты нормализации
- `src/scripts/show-parameter-search-flow.ts` - Демонстрация

## Часто задаваемые вопросы

**Q: Как добавить новый параметр?**  
A: Добавьте запись в таблицу `parameter_dictionary` в БД.

**Q: Как добавить новую единицу измерения?**  
A: Добавьте конверсию в `UnitParser.convertUnit()`.

**Q: Что если словарь не загружен?**  
A: Используется fallback маппер `ParameterNameMapper`.

**Q: Можно ли искать по нескольким параметрам?**  
A: Да, все параметры объединяются через AND.

**Q: Поддерживаются ли OR условия?**  
A: Нет, только AND. Для OR нужно делать несколько запросов.

## Производительность

- ✅ Нормализация кэшируется на уровне SearchEngine
- ✅ Словарь загружается один раз при старте
- ✅ SQL использует индексы на JSONB полях
- ✅ Параметризованные запросы (защита от SQL injection)

## См. также

- `ПОДСКАЗКИ_КАТАЛОГА.md` - Система подсказок при пустых результатах
- `docs/18_ARCHITECTURE_REVIEW.md` - Обзор архитектуры

